import"./modulepreload-polyfill-B5Qt9EMX.js";import{initializeApp as oe}from"https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";import{getDatabase as se,onValue as R,ref as D,set as ae,get as z,remove as q}from"https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";import{getAuth as re,onAuthStateChanged as ie,signInWithEmailAndPassword as le,signOut as de}from"https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";const ce={apiKey:"AIzaSyCjLzq8QNQqhGOpTJy3tzwuQrovMm6Vdi4",authDomain:"unlock-the-lab-workshop.firebaseapp.com",databaseURL:"https://unlock-the-lab-workshop-default-rtdb.europe-west1.firebasedatabase.app",projectId:"unlock-the-lab-workshop",storageBucket:"unlock-the-lab-workshop.firebasestorage.app",messagingSenderId:"604889899913",appId:"1:604889899913:web:d46afe88111e8bcb7d3758",measurementId:"G-VEVYY65K1M"},Q=oe(ce),v=se(Q),H=re(Q);let G={};fetch("papers.json").then(e=>e.json()).then(e=>{e.forEach(t=>{G[t.id]=t})}).catch(e=>console.error("Error loading papers:",e));const w=["STUDY-1","STUDY-2","STUDY-3","STUDY-4","STUDY-5","STUDY-6","STUDY-7","STUDY-8","STUDY-9","STUDY-10","STUDY-11","STUDY-12","STUDY-13","STUDY-14","STUDY-15","STUDY-16","STUDY-17","STUDY-18","STUDY-19","STUDY-20","STUDY-21","STUDY-22","STUDY-23","STUDY-24","STUDY-25","STUDY-26","STUDY-27","STUDY-28","STUDY-29","STUDY-30","STUDY-31","STUDY-32","STUDY-33","STUDY-34","STUDY-35","STUDY-36","STUDY-37","STUDY-38","STUDY-39","STUDY-40","STUDY-41","STUDY-42","STUDY-43","STUDY-44","STUDY-45","STUDY-46","STUDY-47","STUDY-48"],C={"STUDY-1":"low","STUDY-2":"high","STUDY-3":"medium","STUDY-4":"low","STUDY-5":"medium","STUDY-6":"medium","STUDY-7":"low","STUDY-8":"high","STUDY-9":"medium","STUDY-10":"high","STUDY-11":"low","STUDY-12":"medium","STUDY-13":"medium","STUDY-14":"medium","STUDY-15":"medium","STUDY-16":"medium","STUDY-17":"medium","STUDY-18":"medium","STUDY-19":"high","STUDY-20":"low","STUDY-21":"medium","STUDY-22":"high","STUDY-23":"medium","STUDY-24":"high","STUDY-25":"medium","STUDY-26":"medium","STUDY-27":"medium","STUDY-28":"low","STUDY-29":"low","STUDY-30":"medium","STUDY-31":"high","STUDY-32":"low","STUDY-33":"high","STUDY-34":"low","STUDY-35":"medium","STUDY-36":"low","STUDY-37":"high","STUDY-38":"low","STUDY-39":"high","STUDY-40":"low","STUDY-41":"high","STUDY-42":"low","STUDY-43":"high","STUDY-44":"medium","STUDY-45":"medium","STUDY-46":"low","STUDY-47":"high","STUDY-48":"medium"},me={"STUDY-1":1,"STUDY-4":1,"STUDY-29":1,"STUDY-32":1,"STUDY-34":1,"STUDY-40":1,"STUDY-46":1,"STUDY-7":2,"STUDY-11":2,"STUDY-20":2,"STUDY-28":2,"STUDY-36":2,"STUDY-38":2,"STUDY-42":2,"STUDY-9":3,"STUDY-12":3,"STUDY-15":3,"STUDY-17":3,"STUDY-23":3,"STUDY-25":3,"STUDY-44":3,"STUDY-6":4,"STUDY-14":4,"STUDY-18":4,"STUDY-26":4,"STUDY-27":4,"STUDY-30":4,"STUDY-35":4,"STUDY-48":4,"STUDY-3":5,"STUDY-5":5,"STUDY-13":5,"STUDY-16":5,"STUDY-21":5,"STUDY-45":5,"STUDY-2":6,"STUDY-10":6,"STUDY-22":6,"STUDY-31":6,"STUDY-33":6,"STUDY-37":6,"STUDY-41":6,"STUDY-8":7,"STUDY-19":7,"STUDY-24":7,"STUDY-39":7,"STUDY-43":7,"STUDY-47":7},ge=100,ue=localStorage.getItem("sessionId");ue&&(document.getElementById("results-link-display").style.display="block",document.getElementById("results-manual-entry").style.display="none");function pe(){const e=document.getElementById("dashboard-logo");if(!e)return;let t=!1,n=null;const o=["droplet","droplet-star","droplet-heart","droplet-sparkle","droplet-bubble"];e.addEventListener("mouseenter",()=>{t||(n=setTimeout(()=>{s()},900))}),e.addEventListener("mouseleave",()=>{n&&(clearTimeout(n),n=null)}),e.addEventListener("click",i=>{t||(i.preventDefault(),n&&(clearTimeout(n),n=null),s())}),e.addEventListener("touchstart",i=>{t||(i.preventDefault(),s())},{passive:!1}),setInterval(()=>{t||(e.classList.add("shake-intense"),setTimeout(()=>{e.classList.remove("shake-intense")},2e3))},8e3);function s(){if(t)return;t=!0,e.classList.add("flipping");const i=e.src,l=i.replace("unlock-lab-icon.svg","unlock-lab-icon-inverted.svg");setTimeout(()=>{e.src=l},600),setTimeout(()=>{e.src=i},3800);const p=document.createElement("div");p.className="droplet-container",document.body.appendChild(p),setTimeout(()=>{const g=e.getBoundingClientRect(),T=g.left+g.width,h=g.top;for(let r=0;r<12;r++){const a=document.createElement("div"),u=o[Math.floor(Math.random()*o.length)];a.className=`droplet ${u} droplet-refill`;const c=T+(Math.random()-.5)*window.innerWidth*.4,y=(Math.random()-.5)*20,S=h+y;a.style.left=`${c}px`,a.style.top="0px",a.style.width=`${2+Math.random()*.5}vw`,a.style.height=`${(2+Math.random()*.5)*1.2}vw`,a.style.setProperty("--travel-distance",`${S}px`),a.style.animationDelay=`${r*45}ms`,p.appendChild(a)}},2500);const d=e.getBoundingClientRect(),m=8,b=d.left+d.width,f=d.top;for(let g=0;g<m;g++){const T=document.createElement("div"),h=o[Math.floor(Math.random()*o.length)];T.className=`droplet ${h}`;const r=(Math.random()-.5)*20,a=(Math.random()-.5)*20,u=1+Math.random()*.5;T.style.left=`${b+r}px`,T.style.top=`${f+a}px`,T.style.width=`${u}vw`,T.style.height=`${u*1.2}vw`,T.style.animationDelay=`${g*50}ms`,p.appendChild(T)}setTimeout(()=>{const g=e.getBoundingClientRect(),T=g.left,h=g.top+g.height;for(let r=0;r<m;r++){const a=document.createElement("div"),u=o[Math.floor(Math.random()*o.length)];a.className=`droplet ${u}`;const c=(Math.random()-.5)*20,y=(Math.random()-.5)*20,S=1+Math.random()*.5;a.style.left=`${T+c}px`,a.style.top=`${h+y}px`,a.style.width=`${S}vw`,a.style.height=`${S*1.2}vw`,p.appendChild(a)}},600),setTimeout(()=>{e.classList.remove("flipping"),p.remove(),t=!1},4e3)}}pe();window.goToMyResults=function(){const e=localStorage.getItem("sessionId");e&&(window.location.href=`../?session=${e}`)};window.loadFromLink=function(){const e=document.getElementById("sessionLinkInput").value.trim(),t=document.getElementById("link-error");if(!e){t.textContent="‚ö†Ô∏è Please enter a username.",t.style.display="block";return}let n=null;if(e.startsWith("session_")||e.includes("?session="))try{n=new URL(e).searchParams.get("session")}catch{if(e.includes("session=")){const s=e.match(/session=([^&\s]+)/);s&&(n=s[1])}else e.startsWith("session_")&&(n=e)}if(!n&&Y){const o=e.toLowerCase(),s=Object.entries(Y);for(const[i,l]of s)if(l.userName&&l.userName.toLowerCase()===o){n=i;break}if(!n){for(const[i,l]of s)if(l.userName&&l.userName.toLowerCase().includes(o)){n=i;break}}}n?(t.style.display="none",window.location.href=`../?session=${encodeURIComponent(n)}`):(t.textContent=`‚ö†Ô∏è Username "${e}" not found. Make sure you've completed the workshop and entered your username correctly.`,t.style.display="block")};var X;(X=document.getElementById("sessionLinkInput"))==null||X.addEventListener("keypress",function(e){e.key==="Enter"&&window.loadFromLink()});let U;const he=document.getElementById("ratingsChart").getContext("2d");U=new Chart(he,{type:"bar",data:{labels:w,datasets:[{label:"Average Rating",data:[],backgroundColor:function(e){const t=e.dataIndex,n=C[w[t]];return n==="high"?"rgba(16, 185, 129, 0.7)":n==="medium"?"rgba(245, 158, 11, 0.7)":"rgba(239, 68, 68, 0.7)"},borderColor:function(e){const t=e.dataIndex,n=C[w[t]];return n==="high"?"rgba(16, 185, 129, 1)":n==="medium"?"rgba(245, 158, 11, 1)":"rgba(239, 68, 68, 1)"},borderWidth:2,borderRadius:6,errorBars:{}}]},options:{responsive:!0,maintainAspectRatio:!1,onClick:(e,t,n)=>{if(t.length>0){const l=t[0].index,p=w[l];showStudyDetails(p);return}const o=Chart.helpers.getRelativePosition(e,n),s=n.scales.x,i=n.scales.y;if(o.y>i.bottom&&o.y<n.height){const l=s.getValueForPixel(o.x);l>=0&&l<w.length&&showStudyDetails(w[Math.round(l)])}},scales:{y:{beginAtZero:!0,max:7,title:{display:!0,text:"Rating",font:{size:14,weight:"bold"},color:"#374151"}},x:{ticks:{callback:function(e,t){return w[t]},font:{size:10,weight:"bold"},color:"#667eea"}}},plugins:{tooltip:{callbacks:{label:function(e){return`Rating: ${e.parsed.y.toFixed(2)} (click for details)`}}},legend:{display:!1}}},plugins:[{id:"errorBars",afterDatasetsDraw(e){const t=e.ctx,n=e.getDatasetMeta(0),o=e.data.datasets[0].errorBars;n.data.forEach((s,i)=>{if(!o[i])return;const{lower:l,upper:p}=o[i],d=s.x,m=e.data.datasets[0].data[i]||0,b=e.scales.y.getPixelForValue(m),f=s.y+(e.scales.y.getPixelForValue(l)-b),g=s.y+(e.scales.y.getPixelForValue(p)-b);t.save(),t.strokeStyle="rgba(0, 0, 0, 0.8)",t.lineWidth=2,t.beginPath(),t.moveTo(d,f),t.lineTo(d,g),t.stroke(),t.beginPath(),t.moveTo(d-5,f),t.lineTo(d+5,f),t.stroke(),t.beginPath(),t.moveTo(d-5,g),t.lineTo(d+5,g),t.stroke(),t.restore()})}}]});function ye(e){if(!e||e.length===0)return{mean:0,stdDev:0,min:0,max:0,agreement:0,ci95Lower:0,ci95Upper:0};const t=e.length,n=e.reduce((g,T)=>g+T,0)/t,o=e.reduce((g,T)=>g+Math.pow(T-n,2),0)/t,s=Math.sqrt(o),i=Math.min(...e),l=Math.max(...e),p=s/Math.sqrt(t),d=1.96,m=Math.max(1,n-d*p),b=Math.min(7,n+d*p),f=n===0?0:Math.min(100,100*(1-s/n));return{mean:n.toFixed(2),stdDev:s.toFixed(2),min:i.toFixed(1),max:l.toFixed(1),agreement:f.toFixed(0),ci95Lower:m.toFixed(2),ci95Upper:b.toFixed(2)}}function M(e,t,n,o=!0,s=!1){const i=(e-t)/(n-t),l=Math.max(0,Math.min(1,i));if(o)if(s){const p=Math.round(254-34*l),d=Math.round(226+26*l),m=Math.round(226+5*l);return`rgb(${p}, ${d}, ${m})`}else{const p=Math.round(239-223*l),d=Math.round(68+117*l),m=Math.round(68+61*l);return`rgb(${p}, ${d}, ${m})`}else if(s){const p=Math.round(220+34*l),d=Math.round(252-26*l),m=Math.round(231-5*l);return`rgb(${p}, ${d}, ${m})`}else{const p=Math.round(16+223*l),d=Math.round(185-117*l),m=Math.round(129-61*l);return`rgb(${p}, ${d}, ${m})`}}function W(e,t,n){const o={};let s=0;const i=new Set,l={},p=new Set(Object.entries(n||{}).filter(([,r])=>r.userName==="Anonymous").map(([r])=>r)),d=r=>Object.entries(r||{}).reduce((a,[u,c])=>{let y=null;return typeof c=="number"?y=c:c&&typeof c=="object"&&(y=c.rating),Number.isFinite(y)&&y>=1&&y<=7&&!p.has(u)&&a.push({userId:u,rating:y}),a},[]);w.forEach(r=>{const a=e[r]||{},u=d(a),c=u.map(y=>y.rating);u.forEach(y=>{i.add(y.userId),l[y.userId]=(l[y.userId]||0)+1}),s+=c.length}),Object.values(l).filter(r=>r>=12).length;const m=i.size>0;w.forEach(r=>{const a=e[r]||{},c=d(a).map(S=>S.rating);let y;if(m){const S=me[r]||4;y=[...c,...Array(ge).fill(S)]}else y=[];o[r]={...ye(y),count:c.length,totalCount:y.length}}),we(o),document.getElementById("uniqueParticipants").textContent=i.size;const b=document.getElementById("ratings-chart-heading");b&&(b.innerHTML=`üìä Average Quality Ratings by Study (<i>N</i>&nbsp;=&nbsp;${i.size})`);const f=document.getElementById("ratings-chart-desc");f&&(f.innerHTML=`Mean quality rating (1-7 scale) with 95% confidence intervals. Error bars show rating variability‚Äîwider bars indicate less agreement among participants. All ${i.size} participant${i.size!==1?"s":""} with at least one valid rating are included. The leaderboard shows the subset who completed the full workshop. <strong>Click on any bar to view detailed statistics and study information.</strong>`),document.getElementById("totalRatings").textContent=s;const g=t?Object.keys(t).filter(r=>{const a=t[r].lastActive;return Date.now()-a<6e4}).length:0;document.getElementById("activeParticipants").textContent=g;const T=n?Object.fromEntries(Object.entries(n).filter(([,r])=>(r.score||0)>0&&r.userName!=="Anonymous")):{},h=Object.keys(T).length;if(Object.keys(T).length>0){const r=Object.values(T).filter(a=>(a.papersRated||0)>0).map(a=>Math.round(a.score/a.papersRated));if(r.length>0){const a=Math.round(r.reduce((u,c)=>u+c,0)/r.length);document.getElementById("avgScore").textContent=`${a}%`}}if(be(g,h,e),Te(n),m){const r={};w.forEach((u,c)=>{r[c]={lower:parseFloat(o[u].ci95Lower),upper:parseFloat(o[u].ci95Upper)}}),U.data.datasets[0].data=w.map(u=>o[u].mean),U.data.datasets[0].errorBars=r,U.update();const a=document.getElementById("statsTableBody");a.innerHTML=w.map(u=>{const c=o[u],y=C[u],S=y==="high"?"quality-high":y==="medium"?"quality-medium":"quality-low",k=M(c.mean,1,7,!0,!0),E=M(c.stdDev,0,3,!1,!0),x=parseFloat(c.agreement),N=M(x,0,100,!0,!0),O=M(c.count,0,Math.max(...w.map(ne=>o[ne].count)),!0,!0);return`
                        <tr data-study="${u}" data-quality="${y}" data-responses="${c.count}" 
                            data-mean="${c.mean}" data-stddev="${c.stdDev}" data-min="${c.min}" 
                            data-max="${c.max}" data-agreement="${x}">
                            <td><strong><a href="#" onclick="showStudyDetails('${u}'); return false;" style="color: #667eea; text-decoration: none; cursor: pointer;">${u}</a></strong></td>
                            <td>
                                <span class="quality-indicator ${S}"></span>
                                ${y.charAt(0).toUpperCase()+y.slice(1)}
                            </td>
                            <td class="color-scale" style="background: ${O}; color: #1f2937; font-weight: 600;">${c.count}</td>
                            <td class="color-scale" style="background: ${k}; color: #1f2937; font-weight: 600;">${c.mean}</td>
                            <td class="color-scale" style="background: ${E}; color: #1f2937; font-weight: 600;">${c.stdDev}</td>
                            <td>${c.min}</td>
                            <td>${c.max}</td>
                            <td class="color-scale" style="background: ${N}; color: #1f2937; font-weight: 600;">${c.agreement}%</td>
                        </tr>
                    `}).join("")}else{U.data.datasets[0].data=[],U.data.datasets[0].errorBars={},U.update();const r=document.getElementById("statsTableBody");r.innerHTML='<tr><td colspan="8" style="text-align: center; color: #999; padding: 3rem;">üìä No participant data yet. Complete the workshop to see ratings appear here.</td></tr>'}}let L={},I={},A={},_={};R(D(v,"ratings"),e=>{L=e.val()||{},W(L,I,A)});R(D(v,"active"),e=>{I=e.val()||{},W(L,I,A)});R(D(v,"leaderboard"),e=>{A=e.val()||{},W(L,I,A)});R(D(v,"rankings"),e=>{_=e.val()||{},J(K())});function K(){return Object.fromEntries(Object.entries(_).filter(([e])=>{var t;return(((t=Y[e])==null?void 0:t.score)||0)>0}))}const B=[{key:"title",label:"üì∞ Title"},{key:"access",label:"üìö Access"},{key:"source",label:"üèõÔ∏è Source"},{key:"theory",label:"üî¨ Theory"},{key:"methods",label:"üìä Methods & Data"},{key:"conclusion",label:"üìù Conclusion"}];function J(e){var T;const t=document.getElementById("criterion-importance-container");if(!t)return;const n=Object.values(e||{});if(n.length===0){t.innerHTML='<p style="text-align: center; color: #999; padding: 2rem 0;">No data yet.</p>';return}const o=Object.fromEntries(B.map(h=>[h.key,[]]));n.forEach(h=>{const r=B.reduce((a,u)=>a+(Number(h[u.key])||0),0);r<=0||B.forEach(a=>{o[a.key].push((Number(h[a.key])||0)/r)})});const s=((T=o[B[0].key])==null?void 0:T.length)||0;if(s===0){t.innerHTML='<p style="text-align: center; color: #999; padding: 2rem 0;">No valid token allocations yet.</p>';return}const i=10,l=s>=i;function p(h){const r=[[9,2.262],[10,2.228],[11,2.201],[12,2.179],[13,2.16],[14,2.145],[15,2.131],[19,2.093],[24,2.064],[29,2.045],[39,2.023],[59,2.001],[99,1.984],[1/0,1.96]];for(let a=0;a<r.length;a++)if(h<=r[a][0]){if(a===0)return r[0][1];const[u,c]=r[a-1],[y,S]=r[a],k=(h-u)/(y-u);return c+k*(S-c)}return 1.96}const d=l?p(s-1):0,m=B.map(h=>{const r=o[h.key],a=r.reduce((E,x)=>E+x,0)/s;let u=0;if(l&&s>1){const E=r.reduce((N,O)=>N+Math.pow(O-a,2),0)/(s-1),x=Math.sqrt(E/s);u=d*x}const c=a*100,y=u*100,S=Math.max(0,c-y),k=Math.min(100,c+y);return{...h,meanPct:c,ciHalfPct:y,ciLowPct:S,ciHighPct:k}}),b=h=>`${h.toFixed(1)}%`,f=document.getElementById("criterion-importance-count");f&&(f.textContent=`Showing pooled responses from ${s} participant${s!==1?"s":""} with valid token allocations.${l?"":` 95% CI error bars are shown once at least ${i} responses are available.`}`);const g=document.getElementById("criterion-importance-heading");g&&(g.innerHTML=`‚öñÔ∏è Criterion Importance (<i>N</i>&nbsp;=&nbsp;${s})`),t.innerHTML=`
                ${m.map(h=>{const r=b(h.meanPct),a=Math.max(0,h.ciHighPct-h.ciLowPct),u=l?`calc(${h.ciHighPct}% + 8px)`:`calc(${h.meanPct}% + 8px)`;return`
                        <div style="display: flex; align-items: center; gap: 0.75rem; margin-bottom: 0.75rem;">
                            <span style="min-width: 120px; flex-shrink: 0; font-weight: 600; font-size: 0.85rem; color: #374151; white-space: nowrap;" title="${h.label}">${h.label}</span>
                            <div style="flex: 1; position: relative; height: 22px;">
                                <!-- Background track -->
                                <div style="position: absolute; top: 0; left: 0; right: 0; height: 100%; background: #e5e7eb; border-radius: 6px;"></div>
                                <!-- Mean bar -->
                                <div style="position: absolute; top: 0; left: 0; width: ${h.meanPct}%; height: 100%; background: linear-gradient(90deg, #f59e0b, #d97706); border-radius: 6px;"></div>
                                ${l?`
                                <!-- CI horizontal spine centred on bar height -->
                                <div style="position: absolute; top: 50%; transform: translateY(-50%); left: ${h.ciLowPct}%; width: ${a}%; height: 2px; background: #b45309;"></div>
                                <!-- CI low tick (full bar height) -->
                                <div style="position: absolute; top: 0; bottom: 0; left: ${h.ciLowPct}%; width: 1.5px; background: #b45309; transform: translateX(-50%);"></div>
                                <!-- CI high tick (full bar height) -->
                                <div style="position: absolute; top: 0; bottom: 0; left: ${h.ciHighPct}%; width: 1.5px; background: #b45309; transform: translateX(-50%);"></div>
                                `:""}
                                <!-- Mean percentage label -->
                                <span style="position: absolute; top: 50%; transform: translateY(-50%); left: ${u}; font-weight: 700; color: #d97706; font-size: 0.82rem; white-space: nowrap;">${r}</span>
                            </div>
                        </div>`}).join("")}
            `}let P,$=10,j=null;ie(H,e=>{j=e,e&&(document.getElementById("adminEmail").textContent=`‚úÖ Signed in as ${e.email}`)});window.openAdminPanel=function(){document.getElementById("adminOverlay").classList.add("active"),j?(document.getElementById("passwordSection").style.display="none",document.getElementById("adminActions").style.display="block"):(document.getElementById("passwordSection").style.display="block",document.getElementById("adminActions").style.display="none",document.getElementById("adminEmail").value="",document.getElementById("adminPassword").value="",document.getElementById("adminEmail").focus(),fe())};window.closeAdminPanel=function(e){(!e||e.target.id==="adminOverlay"||e.target.classList.contains("btn-cancel"))&&(document.getElementById("adminOverlay").classList.remove("active"),clearInterval(P),$=10)};function fe(){$=10,V(),P=setInterval(()=>{$--,V(),$<=0&&(clearInterval(P),closeAdminPanel({target:{id:"adminOverlay"}}))},1e3)}function V(){const e=document.getElementById("adminTimer");e.textContent=`Time remaining: ${$}s`,$<=3?e.classList.add("warning"):e.classList.remove("warning")}window.handlePasswordKeyPress=function(e){e.key==="Enter"&&verifyPassword()};window.verifyPassword=function(){const e=document.getElementById("adminEmail").value.trim(),t=document.getElementById("adminPassword").value;if(!e||!t){alert("‚ùå Please enter both email and password");return}const n=document.getElementById("loginBtn");n.disabled=!0,n.textContent="Signing in...",le(H,e,t).then(o=>{clearInterval(P),j=o.user,document.getElementById("passwordSection").style.display="none",document.getElementById("adminActions").style.display="block",document.getElementById("adminTitle").textContent="‚úÖ Admin Panel",n.disabled=!1,n.textContent="Sign In"}).catch(o=>{let s="Authentication failed";o.code==="auth/invalid-credential"||o.code==="auth/wrong-password"||o.code==="auth/user-not-found"?s="Invalid email or password":o.code==="auth/too-many-requests"&&(s="Too many failed attempts. Try again later"),alert("‚ùå "+s),document.getElementById("adminPassword").value="",n.disabled=!1,n.textContent="Sign In"})};window.adminSignOut=function(){de(H).then(()=>{j=null,closeAdminPanel({target:{id:"adminOverlay"}})}).catch(e=>{alert("‚ùå Error signing out: "+e.message)})};window.endAllSessions=function(){const e=Object.keys(I).length;if(e===0){alert("‚ÑπÔ∏è No active sessions to end");return}if(confirm(`‚ö†Ô∏è This will end ${e} active session(s).

Are you sure you want to continue?`)){const t=document.getElementById("endSessionsBtn");t.disabled=!0,t.textContent="Ending sessions...",ae(D(v,"active"),null).then(()=>{alert(`‚úÖ Successfully ended ${e} session(s)`),t.disabled=!1,t.textContent="‚èπÔ∏è End all active sessions",closeAdminPanel({target:{id:"adminOverlay"}})}).catch(n=>{alert("‚ùå Error ending sessions: "+n.message),t.disabled=!1,t.textContent="‚èπÔ∏è End all active sessions"})}};window.deleteAllRatingsData=async function(){const e=D(v,"ratings"),t=D(v,"leaderboard"),n=D(v,"rankings");try{const[o,s,i]=await Promise.all([z(e),z(t),z(n)]),l=o.exists(),p=s.exists(),d=i.exists();if(!l&&!p&&!d){alert("‚ÑπÔ∏è No data to delete.");return}let m=0,b=0,f=0;if(l){const r=o.val();Object.values(r).forEach(a=>{m+=Object.keys(a).length})}p&&(b=Object.keys(s.val()).length),d&&(f=Object.keys(i.val()).length);const g=`‚ö†Ô∏è WARNING: You are about to permanently delete:
‚Ä¢ ${m} rating(s)
‚Ä¢ ${b} participant(s) from leaderboard
‚Ä¢ ${f} criterion ranking(s)

This action CANNOT be undone!

Type "DELETE" to confirm:`;if(prompt(g)!=="DELETE"){alert("‚ùå Deletion cancelled.");return}const h=document.getElementById("deleteDataBtn");h.disabled=!0,h.textContent="Deleting data...",await Promise.all([l?q(e):Promise.resolve(),p?q(t):Promise.resolve(),d?q(n):Promise.resolve()]),alert("‚úÖ All data has been permanently deleted."),window.location.reload()}catch(o){alert("‚ùå Error deleting data: "+o.message);const s=document.getElementById("deleteDataBtn");s&&(s.disabled=!1,s.textContent="üóëÔ∏è Delete all ratings data")}};let F={column:-1,ascending:!0};window.sortTable=function(e,t){const n=document.getElementById("statsTable"),o=n.querySelector("tbody"),s=Array.from(o.querySelectorAll("tr")),i=F.column===e?!F.ascending:!0;F={column:e,ascending:i},n.querySelectorAll("th").forEach((m,b)=>{m.classList.remove("sort-asc","sort-desc"),b===e&&m.classList.add(i?"sort-asc":"sort-desc")});const p=["study","quality","responses","mean","stddev","min","max","agreement"][e],d={low:1,medium:2,high:3};s.sort((m,b)=>{let f=m.dataset[p],g=b.dataset[p];return e===1?(f=d[f]||0,g=d[g]||0):t==="number"?(f=parseFloat(f),g=parseFloat(g)):(f=f.toLowerCase(),g=g.toLowerCase()),f<g?i?-1:1:f>g?i?1:-1:0}),s.forEach(m=>o.appendChild(m))};function be(e,t,n){const o=Math.min(100,e/100*100);document.getElementById("connectionUsage").textContent=`${e}/100`,document.getElementById("connectionBar").style.width=`${o}%`;const s=document.getElementById("connectionBar"),i=document.getElementById("connectionUsage");o>=90?(s.style.background="#ef4444",i.style.color="#ef4444"):o>=70?(s.style.background="#f59e0b",i.style.color="#f59e0b"):(s.style.background="#10b981",i.style.color="#10b981");const d=(((n?Object.keys(n).reduce((f,g)=>f+Object.keys(n[g]||{}).length,0):0)*200+e*100+t*150)/(1024*1024)).toFixed(2),m=Math.min(100,d/1024*100);document.getElementById("storageUsage").textContent=`~${d} MB`,document.getElementById("storageBar").style.width=`${m}%`;const b=document.getElementById("storageBar");m>=90?b.style.background="#ef4444":m>=70?b.style.background="#f59e0b":b.style.background="#10b981",document.getElementById("sessionCount").textContent=t}let Z="allTime",Y={};function Te(e){Y=e||{},ee(),J(K())}function Se(e){Z=e;const t=document.getElementById("tab24h"),n=document.getElementById("tabAllTime");e==="24h"?(t.style.color="#059669",t.style.fontWeight="bold",t.style.borderBottom="3px solid #059669",n.style.color="#6b7280",n.style.fontWeight="normal",n.style.borderBottom="3px solid transparent"):(n.style.color="#059669",n.style.fontWeight="bold",n.style.borderBottom="3px solid #059669",t.style.color="#6b7280",t.style.fontWeight="normal",t.style.borderBottom="3px solid transparent"),ee()}window.switchLeaderboardTab=Se;function ee(){const e=document.getElementById("leaderboardGrid");if(!Y||Object.keys(Y).length===0){e.innerHTML='<div style="text-align: center; color: #999; grid-column: 1 / -1;">No completed sessions yet</div>';return}let t=Object.entries(Y).map(([n,o])=>({sessionId:n,userName:o.userName||"Anonymous",score:o.score||0,papersRated:o.papersRated||0,timestamp:o.timestamp||0}));if(t=t.filter(n=>n.score>0&&n.userName!=="Anonymous"),Z==="24h"){const n=Date.now()-864e5;t=t.filter(o=>o.timestamp>=n)}if(t=t.sort((n,o)=>o.score-n.score).slice(0,200),t.length===0){e.innerHTML='<div style="text-align: center; color: #999; grid-column: 1 / -1;">No completed sessions in the past 24 hours</div>';return}e.innerHTML=t.map((n,o)=>{const s=o+1,i=n.papersRated>0?Math.round(n.score/n.papersRated):0,l=s===1?" ü•á":s===2?" ü•à":s===3?" ü•â":"",p=`#${s}`;let d="#f9fafb",m="#e5e7eb";s===1?(d="#fef3c7",m="#fbbf24"):s===2?(d="#e0e7ff",m="#818cf8"):s===3&&(d="#fce7f3",m="#f472b6");const b=s<=3?"bold":"500",f=i>=80?"#10b981":i>=60?"#3b82f6":i>=40?"#f59e0b":"#ef4444";return`
                    <div role="link" tabindex="0" title="View ${n.userName}'s results" onclick="window.location.href='../?session=${encodeURIComponent(n.sessionId)}'" onkeydown="if(event.key==='Enter'||event.key===' ')window.location.href='../?session=${encodeURIComponent(n.sessionId)}'" style="
                        background: ${d};
                        border: 1px solid ${m};
                        border-radius: 6px;
                        padding: 10px;
                        display: flex;
                        align-items: center;
                        justify-content: space-between;
                        gap: 8px;
                        transition: transform 0.2s, box-shadow 0.2s;
                        cursor: pointer;
                    " onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 4px 12px rgba(0,0,0,0.15)';" onmouseout="this.style.transform=''; this.style.boxShadow='';">
                        <div style="font-size: 0.8rem; font-weight: bold; color: #6b7280; flex-shrink: 0;">${p}</div>
                        <div style="font-size: 0.85rem; color: #1f2937; font-weight: ${b}; flex-grow: 1; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">${n.userName}${l}</div>
                        <div style="font-size: 0.9rem; font-weight: bold; color: ${f}; flex-shrink: 0;">${i}%</div>
                    </div>
                `}).join("")}let te={};window.showStudyDetails=function(e){const t=document.getElementById("studyModal"),n=C[e],o=te[e],s=G[e];if(!o){alert("No data available for this study yet.");return}document.getElementById("studyTitle").textContent=e,document.getElementById("studyQuality").innerHTML=`
                <span style="display: inline-block; width: 12px; height: 12px; border-radius: 50%; background: ${n==="high"?"#10b981":n==="medium"?"#f59e0b":"#ef4444"}; margin-right: 8px;"></span>
                <strong>Quality Level:</strong> ${n.charAt(0).toUpperCase()+n.slice(1)}
            `;let i="";s?i=`
                    <div style="background: #f9fafb; padding: 1.5rem; border-radius: 8px; margin-top: 1rem;">
                        <h3 style="margin-top: 0; color: #20B2AA;">Rating Statistics</h3>
                        <table style="width: 100%; border-collapse: collapse;">
                            <tr style="border-bottom: 1px solid #e5e7eb;">
                                <td style="padding: 0.75rem; font-weight: 600;">Participants:</td>
                                <td style="padding: 0.75rem;">${o.count}</td>
                            </tr>
                            <tr style="border-bottom: 1px solid #e5e7eb;">
                                <td style="padding: 0.75rem; font-weight: 600;">Mean Rating:</td>
                                <td style="padding: 0.75rem;">${o.mean} / 7</td>
                            </tr>
                            <tr style="border-bottom: 1px solid #e5e7eb;">
                                <td style="padding: 0.75rem; font-weight: 600;">95% CI:</td>
                                <td style="padding: 0.75rem;">[${o.ci95Lower}, ${o.ci95Upper}]</td>
                            </tr>
                            <tr style="border-bottom: 1px solid #e5e7eb;">
                                <td style="padding: 0.75rem; font-weight: 600;">Std Deviation:</td>
                                <td style="padding: 0.75rem;">${o.stdDev}</td>
                            </tr>
                            <tr style="border-bottom: 1px solid #e5e7eb;">
                                <td style="padding: 0.75rem; font-weight: 600;">Range:</td>
                                <td style="padding: 0.75rem;">${o.min} - ${o.max}</td>
                            </tr>
                            <tr>
                                <td style="padding: 0.75rem; font-weight: 600;">Agreement:</td>
                                <td style="padding: 0.75rem;">${o.agreement}%</td>
                            </tr>
                        </table>
                        <p style="font-size: 0.85rem; color: #6b7280; margin-top: 1rem; margin-bottom: 0;">
                            <strong>What this means:</strong> ${parseInt(o.agreement)>70?"High agreement among participants - ratings are consistent.":parseInt(o.agreement)>40?"Moderate agreement - some variation in ratings.":"Low agreement - participants have quite different opinions about this study."}
                        </p>
                    </div>
                    
                    <hr style="margin: 2rem 0; border: none; border-top: 2px solid #e5e7eb;">
                    
                    <div style="margin-top: 1.5rem;">
                        <h3 style="margin-top: 0; color: #20B2AA;">Study Details</h3>
                        <div style="background: #ffffff; padding: 0.4rem 1rem; border-left: 4px solid #20B2AA; margin-bottom: 1rem;">
                            <h4 style="margin: 0; color: #374151; font-size: 1rem;">${s.title}</h4>
                        </div>
                        
                        <div style="margin-bottom: 1.25rem;">
                            <h4 style="color: #20B2AA; font-size: 0.9rem; margin-bottom: 0.5rem;">üìö Access</h4>
                            <p style="margin: 0; font-size: 0.85rem; line-height: 1.6;">${s.access}</p>
                        </div>
                        
                        <div style="margin-bottom: 1.25rem;">
                            <h4 style="color: #20B2AA; font-size: 0.9rem; margin-bottom: 0.5rem;">üîç Overview</h4>
                            <p style="margin: 0; font-size: 0.85rem; line-height: 1.6;">${s.overview}</p>
                        </div>
                        
                        <div style="margin-bottom: 1.25rem;">
                            <h4 style="color: #20B2AA; font-size: 0.9rem; margin-bottom: 0.5rem;">üß™ Methods</h4>
                            <p style="margin: 0; font-size: 0.85rem; line-height: 1.6;">${s.methods}</p>
                        </div>
                        
                        <div style="margin-bottom: 1.25rem;">
                            <h4 style="color: #20B2AA; font-size: 0.9rem; margin-bottom: 0.5rem;">üí° Conclusion</h4>
                            <p style="margin: 0; font-size: 0.85rem; line-height: 1.6;">${s.conclusion}</p>
                        </div>
                        
                        <div style="margin-bottom: 0;">
                            <h4 style="color: #20B2AA; font-size: 0.9rem; margin-bottom: 0.5rem;">üì∞ Source</h4>
                            <p style="margin: 0; font-size: 0.85rem; line-height: 1.6;">${s.source}</p>
                        </div>
                    </div>
                `:i=`
                    <div style="background: #f9fafb; padding: 1.5rem; border-radius: 8px; margin-top: 1rem;">
                        <h3 style="margin-top: 0; color: #20B2AA;">Rating Statistics</h3>
                        <table style="width: 100%; border-collapse: collapse;">
                            <tr style="border-bottom: 1px solid #e5e7eb;">
                                <td style="padding: 0.75rem; font-weight: 600;">Participants:</td>
                                <td style="padding: 0.75rem;">${o.count}</td>
                            </tr>
                            <tr style="border-bottom: 1px solid #e5e7eb;">
                                <td style="padding: 0.75rem; font-weight: 600;">Mean Rating:</td>
                                <td style="padding: 0.75rem;">${o.mean} / 7</td>
                            </tr>
                            <tr style="border-bottom: 1px solid #e5e7eb;">
                                <td style="padding: 0.75rem; font-weight: 600;">95% CI:</td>
                                <td style="padding: 0.75rem;">[${o.ci95Lower}, ${o.ci95Upper}]</td>
                            </tr>
                            <tr style="border-bottom: 1px solid #e5e7eb;">
                                <td style="padding: 0.75rem; font-weight: 600;">Std Deviation:</td>
                                <td style="padding: 0.75rem;">${o.stdDev}</td>
                            </tr>
                            <tr style="border-bottom: 1px solid #e5e7eb;">
                                <td style="padding: 0.75rem; font-weight: 600;">Range:</td>
                                <td style="padding: 0.75rem;">${o.min} - ${o.max}</td>
                            </tr>
                            <tr>
                                <td style="padding: 0.75rem; font-weight: 600;">Agreement:</td>
                                <td style="padding: 0.75rem;">${o.agreement}%</td>
                            </tr>
                        </table>
                        <p style="font-size: 0.85rem; color: #6b7280; margin-top: 1rem; margin-bottom: 0;">
                            <strong>What this means:</strong> ${parseInt(o.agreement)>70?"High agreement among participants - ratings are consistent.":parseInt(o.agreement)>40?"Moderate agreement - some variation in ratings.":"Low agreement - participants have quite different opinions about this study."}
                        </p>
                    </div>
                `,document.getElementById("studyStats").innerHTML=i,t.classList.add("active")};window.closeStudyModal=function(){document.getElementById("studyModal").classList.remove("active")};document.addEventListener("keydown",function(e){(e.key==="Escape"||e.key==="Esc")&&document.getElementById("studyModal").classList.contains("active")&&closeStudyModal()});function we(e){te=e}
