<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Unlock the Lab - Live Dashboard</title>
    <link rel="icon" type="image/x-icon" href="img/favicon.ico">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
            text-shadow: 0 1px 3px rgba(0,0,0,0.3);
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        header {
            background: white;
            border-radius: 12px;
            padding: 20px 30px 12px;
            margin-bottom: 20px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        header h1 {
            background: linear-gradient(135deg, #20B2AA 0%, #48d1cc 30%, #ff9a56 70%, #ff6b35 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            text-shadow: none;
            font-size: 2rem;
            display: flex;
            align-items: center;
            gap: 0.3rem;
            line-height: 1;
        }

        .dashboard-logo {
            height: 2rem;
            flex-shrink: 0;
            margin-bottom: 0.3rem;
            cursor: pointer;
            animation: logoShake 2s ease-in-out infinite;
            transform-origin: center;
        }

        .dashboard-logo.shake-intense {
            animation: logoShakeIntense 0.3s ease-in-out infinite;
        }

        .dashboard-logo.flipping {
            animation: logoFlipWithShake 4s ease-in-out forwards;
        }

        @keyframes logoShake {
            0% { transform: rotate(0deg); }
            12.5% { transform: rotate(-4deg); }
            25% { transform: rotate(-8deg); }
            37.5% { transform: rotate(-4deg); }
            50% { transform: rotate(0deg); }
            62.5% { transform: rotate(4deg); }
            75% { transform: rotate(8deg); }
            87.5% { transform: rotate(4deg); }
            100% { transform: rotate(0deg); }
        }

        @keyframes logoShakeIntense {
            0%, 100% { transform: rotate(0deg); }
            25% { transform: rotate(-15deg); }
            75% { transform: rotate(15deg); }
        }

        @keyframes logoFlipWithShake {
            0% { transform: rotate(0deg); }
            2% { transform: rotate(-15deg); }
            4% { transform: rotate(15deg); }
            6% { transform: rotate(-12deg); }
            8% { transform: rotate(12deg); }
            10% { transform: rotate(-8deg); }
            12% { transform: rotate(8deg); }
            15% { transform: rotate(180deg); }
            85% { transform: rotate(180deg); }
            100% { transform: rotate(360deg); }
        }

        .droplet-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 9999;
            overflow: hidden;
        }

        .droplet {
            position: absolute;
            background: radial-gradient(ellipse at 50% 30%, #ffaa33 0%, #ff8c42 40%, #ff6b35 70%, #cc5528 100%);
            border-radius: 50%;
            opacity: 0;
            box-shadow:
                0 2px 6px rgba(255, 107, 53, 0.5),
                0 4px 12px rgba(255, 107, 53, 0.3),
                inset 0 -2px 4px rgba(0, 0, 0, 0.2),
                inset 0 2px 4px rgba(255, 200, 100, 0.3);
            animation: dropletDrop 3s cubic-bezier(0.4, 0, 0.6, 1) forwards;
        }

        @keyframes dropletDrop {
            0% {
                opacity: 0;
                transform: translateY(0) scale(0.5);
            }
            5% {
                opacity: 0.9;
                transform: translateY(10px) scale(1);
            }
            15% {
                transform: translateY(30px) scale(2);
            }
            40% {
                transform: translateY(50vh) scale(4);
            }
            70% {
                transform: translateY(80vh) scale(6);
            }
            100% {
                opacity: 0.3;
                transform: translateY(120vh) scale(8);
            }
        }

        .droplet-star {
            background: linear-gradient(135deg, #ffd700 0%, #ffed4e 50%, #ffaa00 100%);
            clip-path: polygon(50% 0%, 61% 35%, 98% 35%, 68% 57%, 79% 91%, 50% 70%, 21% 91%, 32% 57%, 2% 35%, 39% 35%);
            border-radius: 0;
            box-shadow:
                0 0 10px rgba(255, 215, 0, 0.8),
                0 0 20px rgba(255, 215, 0, 0.5),
                0 2px 6px rgba(255, 170, 0, 0.5);
        }

        .droplet-heart {
            background: linear-gradient(135deg, #ff69b4 0%, #ff1493 50%, #c71585 100%);
            border-radius: 0;
            box-shadow:
                0 0 8px rgba(255, 105, 180, 0.6),
                0 2px 6px rgba(255, 20, 147, 0.4);
        }

        .droplet-heart::before {
            content: '';
            position: absolute;
            width: 100%;
            height: 100%;
            background: inherit;
            border-radius: 50% 50% 0 0;
            transform: rotate(-45deg);
            transform-origin: 0 100%;
        }

        .droplet-heart::after {
            content: '';
            position: absolute;
            width: 100%;
            height: 100%;
            background: inherit;
            border-radius: 50% 50% 0 0;
            transform: rotate(45deg);
            transform-origin: 100% 100%;
        }

        .droplet-sparkle {
            background: radial-gradient(circle, #ffffff 0%, #add8e6 40%, #4bb3e3 100%);
            border-radius: 50%;
            box-shadow:
                0 0 15px rgba(255, 255, 255, 1),
                0 0 30px rgba(173, 216, 230, 0.8),
                0 0 45px rgba(75, 179, 227, 0.6);
        }

        .droplet-bubble {
            background: radial-gradient(circle at 30% 30%, rgba(255, 255, 255, 0.9) 0%, rgba(173, 216, 230, 0.6) 50%, rgba(135, 206, 235, 0.3) 100%);
            border-radius: 50%;
            border: 2px solid rgba(255, 255, 255, 0.5);
            box-shadow:
                inset 0 -10px 20px rgba(135, 206, 235, 0.3),
                inset 0 10px 20px rgba(255, 255, 255, 0.5),
                0 0 10px rgba(173, 216, 230, 0.4);
        }

        @keyframes dropletRefill {
            0% {
                opacity: 0;
                transform: translateY(0) scale(2.5);
            }
            8% {
                opacity: 0.95;
                transform: translateY(calc(var(--travel-distance) * 0.15)) scale(2);
            }
            25% {
                opacity: 1;
                transform: translateY(calc(var(--travel-distance) * 0.4)) scale(1.2);
            }
            50% {
                opacity: 0.9;
                transform: translateY(calc(var(--travel-distance) * 0.65)) scale(0.6);
            }
            75% {
                opacity: 0.6;
                transform: translateY(calc(var(--travel-distance) * 0.85)) scale(0.25);
            }
            90% {
                opacity: 0.3;
                transform: translateY(calc(var(--travel-distance) * 0.95)) scale(0.1);
            }
            100% {
                opacity: 0;
                transform: translateY(var(--travel-distance)) scale(0.05);
            }
        }

        .droplet-refill {
            animation: dropletRefill 1.1s cubic-bezier(0.25, 0, 0.1, 1) forwards;
        }

        h1 {
            color: #20B2AA;
            font-size: 2rem;
            margin-bottom: 4px;
        }

        .status {
            display: flex;
            align-items: center;
            gap: 10px;
            color: #666;
            font-size: 0.9rem;
        }

        .status-indicator {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: #10b981;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .stat-card {
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        .stat-value {
            font-size: 2.5rem;
            font-weight: bold;
            color: #20B2AA;
        }

        .stat-label {
            color: #666;
            font-size: 0.9rem;
            margin-top: 5px;
        }

        .charts-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(500px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .chart-card {
            background: white;
            border-radius: 12px;
            padding: 25px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        .chart-card h2 {
            color: #20B2AA;
            font-size: 1.3rem;
            margin-bottom: 20px;
        }

        .chart-container {
            position: relative;
            height: 400px;
            cursor: pointer;
        }

        .data-table {
            background: white;
            border-radius: 12px;
            padding: 25px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            overflow-x: auto;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th, td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #e5e7eb;
        }

        th {
            background: #f9fafb;
            color: #20B2AA;
            font-weight: 600;
            cursor: pointer;
            user-select: none;
            position: relative;
            padding-right: 25px;
        }

        th:hover {
            background: #f3f4f6;
        }

        th.sortable::after {
            content: '‚áÖ';
            position: absolute;
            right: 8px;
            color: #9ca3af;
            font-size: 0.8em;
        }

        th.sort-asc::after {
            content: '‚Üë';
            color: #20B2AA;
        }

        th.sort-desc::after {
            content: '‚Üì';
            color: #20B2AA;
        }

        tbody tr:hover {
            background: #f9fafb;
        }

        /* Color scale cells */
        .color-scale {
            font-weight: 600;
            border-radius: 4px;
            padding: 6px 12px !important;
        }

        .quality-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 8px;
        }

        .quality-high { background: #10b981; }
        .quality-medium { background: #f59e0b; }
        .quality-low { background: #ef4444; }

        .admin-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.8);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        .admin-overlay.active {
            display: flex;
        }

        .admin-panel {
            background: white;
            border-radius: 12px;
            padding: 30px;
            max-width: 400px;
            width: 90%;
            box-shadow: 0 10px 40px rgba(0,0,0,0.3);
        }

        .admin-panel h3 {
            color: #20B2AA;
            margin-bottom: 20px;
            font-size: 1.5rem;
        }

        .admin-input {
            width: 100%;
            padding: 12px;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            font-size: 16px;
            margin-bottom: 15px;
        }

        .admin-input:focus {
            outline: none;
            border-color: #20B2AA;
        }

        .admin-timer {
            text-align: center;
            color: #666;
            font-size: 0.9rem;
            margin-bottom: 15px;
        }

        .admin-timer.warning {
            color: #ef4444;
            font-weight: bold;
        }

        .admin-buttons {
            display: flex;
            gap: 10px;
        }

        .admin-buttons button {
            flex: 1;
            padding: 12px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .btn-cancel {
            background: #e5e7eb;
            color: #666;
        }

        .btn-cancel:hover {
            background: #d1d5db;
        }

        .btn-submit {
            background: #667eea;
            color: white;
        }

        .btn-submit:hover {
            background: #5568d3;
        }

        .admin-actions {
            margin-top: 20px;
        }

        .btn-danger {
            width: 100%;
            padding: 15px;
            background: #ef4444;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }

        .btn-danger:hover {
            background: #dc2626;
        }

        .btn-danger:disabled {
            background: #d1d5db;
            cursor: not-allowed;
        }

        @media (max-width: 768px) {
            body {
                padding: 12px 8px;
            }

            header {
                padding: 16px 14px 10px;
            }

            .stat-card,
            .chart-card,
            .data-table {
                padding: 16px 12px;
            }

            .section-panel {
                padding: 1.25rem 0.875rem !important;
            }

            #results-access-section {
                padding: 16px 12px !important;
            }

            .charts-grid {
                grid-template-columns: 1fr;
            }
            
            h1 {
                font-size: 1.5rem;
            }
            
            #leaderboardGrid {
                grid-template-columns: repeat(2, 1fr) !important;
            }
        }
        
        @media (max-width: 480px) {
            body {
                padding: 8px 4px;
            }

            header {
                padding: 12px 10px 8px;
            }

            .stat-card,
            .chart-card,
            .data-table {
                padding: 12px 8px;
            }

            .section-panel {
                padding: 1rem 0.625rem !important;
            }

            #results-access-section {
                padding: 12px 8px !important;
            }

            #leaderboardGrid {
                grid-template-columns: 1fr !important;
            }
        }
        
        /* Study Details Modal */
        .study-modal {
            display: none;
            position: fixed;
            z-index: 2000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.7);
            align-items: center;
            justify-content: center;
        }
        
        .study-modal.active {
            display: flex;
        }
        
        .study-modal-content {
            background: white;
            border-radius: 12px;
            padding: 2rem;
            max-width: 600px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 10px 40px rgba(0,0,0,0.3);
        }
        
        .study-modal-close {
            float: right;
            font-size: 2rem;
            font-weight: bold;
            color: #9ca3af;
            cursor: pointer;
            line-height: 1;
        }
        
        .study-modal-close:hover {
            color: #374151;
        }
        
        .leaderboard-tab:hover {
            color: #20B2AA !important;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1><img id="dashboard-logo" src="unlock-lab-icon.svg" alt="Unlock the Lab" class="dashboard-logo"> Unlock the Lab - Live Dashboard</h1>
        </header>

        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-value" id="avgScore">0</div>
                <div class="stat-label">Average Score</div>
                <p style="font-size: 0.75rem; color: #9ca3af; margin-top: 0.5rem;">Mean prediction accuracy score across all participants</p>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="totalRatings">0</div>
                <div class="stat-label">Total Ratings</div>
                <p style="font-size: 0.75rem; color: #9ca3af; margin-top: 0.5rem;">Number of study ratings submitted by all participants</p>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="uniqueParticipants">0</div>
                <div class="stat-label">Participants</div>
                <p style="font-size: 0.75rem; color: #9ca3af; margin-top: 0.5rem;">Total number of different users who have submitted ratings</p>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="activeParticipants">0</div>
                <div class="stat-label">Active Now</div>
                <p style="font-size: 0.75rem; color: #9ca3af; margin-top: 0.5rem;">Users currently rating studies (active in last 60 seconds)</p>
            </div>
        </div>

        <!-- Review Your Results Section -->
        <div id="results-access-section" class="stat-card" style="margin-bottom: 20px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 25px; text-shadow: 0 1px 3px rgba(0,0,0,0.3);">
            <h2 style="color: white; margin-bottom: 15px; font-weight: 600;">üìä Review Your Results</h2>
            <p style="margin-bottom: 15px; font-size: 0.95rem; font-weight: 400;">Completed the workshop? Enter your username below to view your personalised results page.</p>
            <div id="results-link-display" style="display: none; padding: 15px; background: rgba(255,255,255,0.2); border-radius: 8px; margin-bottom: 10px;">
                <p style="margin-bottom: 10px; font-size: 0.9rem;">Your session was detected!</p>
                <button onclick="goToMyResults()" style="padding: 12px 24px; background: white; color: #667eea; border: none; border-radius: 8px; font-size: 1rem; font-weight: 600; cursor: pointer; box-shadow: 0 2px 4px rgba(0,0,0,0.1); transition: transform 0.2s;">
                    üîç View my results
                </button>
            </div>
            <div id="results-manual-entry">
                <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                    <input type="text" id="sessionLinkInput" placeholder="Enter your username..." style="flex: 1; min-width: 250px; max-width: 400px; padding: 12px; border: 2px solid rgba(255,255,255,0.3); border-radius: 8px; font-size: 0.95rem; background: rgba(255,255,255,0.9);">
                    <button onclick="loadFromLink()" style="padding: 12px 24px; background: white; color: #667eea; border: none; border-radius: 8px; font-size: 1rem; font-weight: 600; cursor: pointer; box-shadow: 0 2px 4px rgba(0,0,0,0.1); transition: transform 0.2s; white-space: nowrap;">
                        üîç View my results
                    </button>
                </div>
                <p id="link-error" style="display: none; color: #fecaca; font-size: 0.85rem; margin-top: 10px;">‚ö†Ô∏è Please enter a valid username.</p>
            </div>
        </div>

        <!-- SECTION 1: PREDICTION PERFORMANCE -->
        <div class="section-panel" style="margin-bottom: 2rem; padding: 1.5rem; background: linear-gradient(135deg, #10b981 0%, #059669 100%); border-radius: 12px; color: white;">
            <h2 style="margin-top: 0; color: white; font-size: 1.8rem; border-bottom: 2px solid rgba(255,255,255,0.3); padding-bottom: 0.75rem;">
                üéØ Part 1: Prediction Performance
            </h2>
            <p style="font-size: 1rem; margin-bottom: 0; opacity: 0.95;">
                How well did participants predict what others would rate each study?
            </p>
        </div>

        <!-- Leaderboard Section -->
        <div class="data-table" style="margin-bottom: 40px;">
            <h2 style="color: #059669; margin-bottom: 10px;">üèÜ Top Predictors</h2>
            <p style="font-size: 0.85rem; color: #6b7280; margin-bottom: 15px;">Top performers ranked by prediction accuracy. Scores show how well participants predicted crowd ratings. The leaderboard includes all participants who have submitted at least one rating. <strong>Click any entry to view that participant's personalised results page.</strong></p>
            
            <!-- Leaderboard Tabs -->
            <div style="display: flex; gap: 10px; margin-bottom: 20px; border-bottom: 2px solid #e5e7eb;">
                <button id="tabAllTime" class="leaderboard-tab active" onclick="switchLeaderboardTab('allTime')" style="padding: 10px 20px; border: none; background: none; color: #059669; font-weight: bold; cursor: pointer; border-bottom: 3px solid #059669; transition: all 0.2s;">
                    üåü All-time leaders
                </button>
                <button id="tab24h" class="leaderboard-tab" onclick="switchLeaderboardTab('24h')" style="padding: 10px 20px; border: none; background: none; color: #6b7280; font-weight: normal; cursor: pointer; border-bottom: 3px solid transparent; transition: all 0.2s;">
                    üìÖ Past 24 hours
                </button>
            </div>
            
            <div id="leaderboardGrid" style="display: grid; grid-template-columns: repeat(5, 1fr); gap: 10px;">
                <div style="text-align: center; color: #999; grid-column: 1 / -1;">Loading leaderboard...</div>
            </div>
        </div>

        <!-- SECTION 1b: CRITERION IMPORTANCE -->
        <div class="data-table" style="margin-bottom: 40px;">
            <h2 id="criterion-importance-heading" style="color: #d97706; margin-bottom: 10px;">‚öñÔ∏è Criterion Importance</h2>
            <p style="font-size: 0.85rem; color: #6b7280; margin-bottom: 20px;">Average percentage of tokens assigned to each criterion by participants, reflecting what they considered most important when evaluating study quality. Error bars show 95% confidence intervals for the mean percentage across participants. <span id="criterion-importance-count"></span></p>
            <div id="criterion-importance-container">
                <p style="text-align: center; color: #999; padding: 2rem 0;">No data yet.</p>
            </div>
        </div>

        <!-- SECTION 2: RATING PATTERNS -->
        <div class="section-panel" style="margin-bottom: 2rem; padding: 1.5rem; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 12px; color: white; text-shadow: 0 1px 3px rgba(0,0,0,0.3);">
            <h2 style="margin-top: 0; color: white; font-size: 1.8rem; border-bottom: 2px solid rgba(255,255,255,0.3); padding-bottom: 0.75rem; font-weight: 600;">
                üìä Part 2: Rating Patterns
            </h2>
            <p style="font-size: 1rem; margin-bottom: 0; opacity: 0.95; font-weight: 400;">
                How did participants actually rate the quality of each study?
            </p>
        </div>

        <div class="charts-grid">
            <div class="chart-card" style="grid-column: 1 / -1;">
                <h2 id="ratings-chart-heading">üìä Average Quality Ratings by Study</h2>
                <p id="ratings-chart-desc" style="font-size: 0.85rem; color: #6b7280; margin-bottom: 1rem;">Mean quality rating (1-7 scale) with 95% confidence intervals. Error bars show rating variability‚Äîwider bars indicate less agreement among participants. All participants with at least one valid rating are included. The leaderboard shows the subset who completed the full workshop. <strong>Click on any bar to view detailed statistics and study information.</strong></p>
                <div class="chart-container">
                    <canvas id="ratingsChart"></canvas>
                </div>
            </div>
        </div>

        <div class="data-table">
            <h2 style="color: #20B2AA; margin-bottom: 10px;">üìà Detailed Rating Statistics</h2>
            <p style="font-size: 0.85rem; color: #6b7280; margin-bottom: 20px;">Complete breakdown of how participants rated each study's quality. Std Dev measures disagreement (higher = more variable ratings). Agreement % shows consensus level. Color scales highlight relative values. <strong>Click study names to view detailed information.</strong> Click column headers to sort.</p>
            <table id="statsTable">
                <thead>
                    <tr>
                        <th class="sortable" onclick="sortTable(0, 'string')" title="Click to sort">Study</th>
                        <th class="sortable" onclick="sortTable(1, 'string')" title="Click to sort">Quality</th>
                        <th class="sortable" onclick="sortTable(2, 'number')" title="Click to sort">Responses</th>
                        <th class="sortable" onclick="sortTable(3, 'number')" title="Click to sort">Mean Rating</th>
                        <th class="sortable" onclick="sortTable(4, 'number')" title="Click to sort">Std Dev</th>
                        <th class="sortable" onclick="sortTable(5, 'number')" title="Click to sort">Min</th>
                        <th class="sortable" onclick="sortTable(6, 'number')" title="Click to sort">Max</th>
                        <th class="sortable" onclick="sortTable(7, 'number')" title="Click to sort">Agreement %</th>
                    </tr>
                </thead>
                <tbody id="statsTableBody">
                    <tr><td colspan="8" style="text-align: center; color: #999;">Loading data...</td></tr>
                </tbody>
            </table>
        </div>
    </div>

    <!-- Study Details Modal -->
    <div class="study-modal" id="studyModal" onclick="closeStudyModal()">
        <div class="study-modal-content" onclick="event.stopPropagation()">
            <span class="study-modal-close" onclick="closeStudyModal()">&times;</span>
            <div id="studyDetailsContent">
                <h2 id="studyTitle"></h2>
                <p id="studyQuality"></p>
                <div id="studyStats"></div>
            </div>
        </div>
    </div>
    
    <!-- Authorship & Project Info -->
    <div style="max-width: 1400px; margin: 2rem auto 0; padding: 1.25rem; background: #f8fafc; border-radius: 8px; font-size: 0.9rem; color: #64748b;">
        <p style="margin-bottom: 0.5rem;"><strong>Author:</strong> Dr Pablo Bernabeu, Department of Education, University of Oxford</p>
        <p style="margin-bottom: 0.5rem; font-size: 0.85rem; color: #64748b;"><strong>Legal disclaimer:</strong> This app and workshop were created by Dr Pablo Bernabeu in a personal capacity during spare time. The employer is not affiliated with, does not endorse, and bears no liability for this app or workshop.</p>
        <p style="margin-bottom: 0.5rem;"><strong>Materials:</strong> <a href="https://github.com/pablobernabeu/Unlock_the_Lab" target="_blank" rel="noopener noreferrer" style="color: #2563eb; text-decoration: none; border-bottom: 1px solid #2563eb;">github.com/pablobernabeu/Unlock_the_Lab</a></p>
        <p style="margin-bottom: 0.5rem;"><strong>Licence:</strong> <a href="https://creativecommons.org/licenses/by/4.0/" target="_blank" rel="noopener noreferrer" style="color: #2563eb; text-decoration: none;">CC BY 4.0</a> ‚Äî Free to use with attribution</p>
        <p style="margin-bottom: 0; font-size: 0.85rem; font-style: italic;">üí° Contributions welcome! Suggest improvements or report issues on <a href="https://github.com/pablobernabeu/Unlock_the_Lab/issues" target="_blank" rel="noopener noreferrer" style="color: #2563eb; text-decoration: none; border-bottom: 1px solid #2563eb;">GitHub</a>.</p>
    </div>
    
    <!-- Admin Link -->
    <p style="max-width: 1400px; margin: 2rem auto; padding-right: 20px; text-align: right; font-size: 0.8rem;"><a href="#" onclick="openAdminPanel(); return false;" style="color: #94a3b8; text-decoration: none; cursor: pointer;">Admin</a></p>

    <!-- Admin Overlay -->
    <div class="admin-overlay" id="adminOverlay" onclick="closeAdminPanel(event)">
        <div class="admin-panel" onclick="event.stopPropagation()">
            <h3 id="adminTitle">üîê Admin Access</h3>
            
            <div id="passwordSection">
                <input 
                    type="email" 
                    id="adminEmail" 
                    class="admin-input" 
                    placeholder="Admin email"
                    onkeypress="handlePasswordKeyPress(event)"
                    autofocus
                >
                <input 
                    type="password" 
                    id="adminPassword" 
                    class="admin-input" 
                    placeholder="Password"
                    onkeypress="handlePasswordKeyPress(event)"
                >
                <div class="admin-timer" id="adminTimer">Time remaining: 10s</div>
                <div class="admin-buttons">
                    <button class="btn-cancel" onclick="closeAdminPanel()">Cancel</button>
                    <button class="btn-submit" onclick="verifyPassword()" id="loginBtn">Sign in</button>
                </div>
            </div>

            <div id="adminActions" style="display: none;">
                <p style="color: #666; margin-bottom: 15px;" id="adminEmail"></p>
                
                <!-- Firebase Usage Statistics (Admin Only) -->
                <div style="margin-bottom: 20px; padding: 15px; background: #f8fafc; border: 2px solid #e5e7eb; border-radius: 8px;">
                    <h4 style="color: #20B2AA; margin-bottom: 12px; font-size: 1rem;">üìä Firebase Usage (Free Tier Limits)</h4>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 12px;">
                        <div style="padding: 12px; background: white; border-radius: 6px; border-left: 4px solid #20B2AA;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 6px;">
                                <span style="font-weight: 600; color: #374151; font-size: 0.85rem;">Connections</span>
                                <span id="connectionUsage" style="font-size: 1.1rem; font-weight: bold; color: #10b981;">0/100</span>
                            </div>
                            <div style="height: 6px; background: #e5e7eb; border-radius: 3px; overflow: hidden;">
                                <div id="connectionBar" style="height: 100%; background: #10b981; width: 0%; transition: all 0.3s;"></div>
                            </div>
                            <p style="font-size: 0.7rem; color: #6b7280; margin-top: 6px; margin-bottom: 0;">Active in last 60s</p>
                        </div>
                        <div style="padding: 12px; background: white; border-radius: 6px; border-left: 4px solid #3b82f6;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 6px;">
                                <span style="font-weight: 600; color: #374151; font-size: 0.85rem;">Storage</span>
                                <span id="storageUsage" style="font-size: 1.1rem; font-weight: bold; color: #10b981;">~0 MB</span>
                            </div>
                            <div style="height: 6px; background: #e5e7eb; border-radius: 3px; overflow: hidden;">
                                <div id="storageBar" style="height: 100%; background: #10b981; width: 0%; transition: all 0.3s;"></div>
                            </div>
                            <p style="font-size: 0.7rem; color: #6b7280; margin-top: 6px; margin-bottom: 0;">1 GB limit</p>
                        </div>
                        <div style="padding: 12px; background: white; border-radius: 6px; border-left: 4px solid #f59e0b;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 6px;">
                                <span style="font-weight: 600; color: #374151; font-size: 0.85rem;">Sessions</span>
                                <span id="sessionCount" style="font-size: 1.1rem; font-weight: bold; color: #20B2AA;">0</span>
                            </div>
                            <p style="font-size: 0.7rem; color: #6b7280; margin-top: 6px; margin-bottom: 0;">Completed</p>
                        </div>
                    </div>
                    <p style="font-size: 0.75rem; color: #64748b; margin-top: 12px; margin-bottom: 0;"><strong>Note:</strong> Free tier: 100 connections, 1 GB storage, 10 GB/month downloads.</p>
                </div>
                
                <div class="admin-actions">
                    <button class="btn-danger" onclick="endAllSessions()" id="endSessionsBtn">
                        ‚èπÔ∏è End all active sessions
                    </button>
                    <button class="btn-danger" onclick="deleteAllRatingsData()" id="deleteDataBtn" style="margin-top: 10px;">
                        üóëÔ∏è Delete all ratings data
                    </button>
                </div>
                <div class="admin-buttons" style="margin-top: 15px;">
                    <button class="btn-cancel" onclick="adminSignOut()" style="background: #ef4444; color: white;">Sign out</button>
                    <button class="btn-cancel" onclick="closeAdminPanel()">Close</button>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getDatabase, ref, onValue, set, remove, get } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js';
        import { getAuth, signInWithEmailAndPassword, onAuthStateChanged, signOut } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';

        const firebaseConfig = {
            apiKey: "AIzaSyCjLzq8QNQqhGOpTJy3tzwuQrovMm6Vdi4",
            authDomain: "unlock-the-lab-workshop.firebaseapp.com",
            databaseURL: "https://unlock-the-lab-workshop-default-rtdb.europe-west1.firebasedatabase.app",
            projectId: "unlock-the-lab-workshop",
            storageBucket: "unlock-the-lab-workshop.firebasestorage.app",
            messagingSenderId: "604889899913",
            appId: "1:604889899913:web:d46afe88111e8bcb7d3758",
            measurementId: "G-VEVYY65K1M"
        };

        const app = initializeApp(firebaseConfig);
        const database = getDatabase(app);
        const auth = getAuth(app);

        // Load papers data for study details
        let papersData = {};
        fetch('papers.json')
            .then(response => response.json())
            .then(papers => {
                papers.forEach(paper => {
                    papersData[paper.id] = paper;
                });
            })
            .catch(error => console.error('Error loading papers:', error));

        const paperIds = ['STUDY-1', 'STUDY-2', 'STUDY-3', 'STUDY-4', 'STUDY-5', 'STUDY-6', 
                          'STUDY-7', 'STUDY-8', 'STUDY-9', 'STUDY-10', 'STUDY-11', 'STUDY-12',
                          'STUDY-13', 'STUDY-14', 'STUDY-15', 'STUDY-16', 'STUDY-17', 'STUDY-18',
                          'STUDY-19', 'STUDY-20', 'STUDY-21', 'STUDY-22', 'STUDY-23', 'STUDY-24',
                          'STUDY-25', 'STUDY-26', 'STUDY-27', 'STUDY-28', 'STUDY-29', 'STUDY-30',
                          'STUDY-31', 'STUDY-32', 'STUDY-33', 'STUDY-34', 'STUDY-35', 'STUDY-36',
                          'STUDY-37', 'STUDY-38', 'STUDY-39', 'STUDY-40', 'STUDY-41', 'STUDY-42',
                          'STUDY-43', 'STUDY-44', 'STUDY-45', 'STUDY-46', 'STUDY-47', 'STUDY-48'];
        const paperQualities = {
            'STUDY-1': 'low', 'STUDY-2': 'high', 'STUDY-3': 'medium', 'STUDY-4': 'low',
            'STUDY-5': 'medium', 'STUDY-6': 'medium', 'STUDY-7': 'low', 'STUDY-8': 'high',
            'STUDY-9': 'medium', 'STUDY-10': 'high', 'STUDY-11': 'low', 'STUDY-12': 'medium',
            'STUDY-13': 'medium', 'STUDY-14': 'medium', 'STUDY-15': 'medium', 'STUDY-16': 'medium',
            'STUDY-17': 'medium', 'STUDY-18': 'medium', 'STUDY-19': 'high', 'STUDY-20': 'low',
            'STUDY-21': 'medium', 'STUDY-22': 'high', 'STUDY-23': 'medium', 'STUDY-24': 'high',
            'STUDY-25': 'medium', 'STUDY-26': 'medium', 'STUDY-27': 'medium', 'STUDY-28': 'low',
            'STUDY-29': 'low', 'STUDY-30': 'medium', 'STUDY-31': 'high', 'STUDY-32': 'low',
            'STUDY-33': 'high', 'STUDY-34': 'low', 'STUDY-35': 'medium', 'STUDY-36': 'low',
            'STUDY-37': 'high', 'STUDY-38': 'low', 'STUDY-39': 'high', 'STUDY-40': 'low',
            'STUDY-41': 'high', 'STUDY-42': 'low', 'STUDY-43': 'high', 'STUDY-44': 'medium',
            'STUDY-45': 'medium', 'STUDY-46': 'low', 'STUDY-47': 'high', 'STUDY-48': 'medium'
        };
        
        // Seed scores (vetted expert ratings) - weighted as 100 participants each
        // Distribution: ~7 papers per quality score (1-7) for balanced assessment
        const seedScores = {
            // Score 1 (Predatory/Pseudoscience) - 7 papers
            'STUDY-1': 1, 'STUDY-4': 1, 'STUDY-29': 1, 'STUDY-32': 1, 'STUDY-34': 1, 'STUDY-40': 1, 'STUDY-46': 1,
            // Score 2 (Marketing/Severe Conflicts) - 7 papers
            'STUDY-7': 2, 'STUDY-11': 2, 'STUDY-20': 2, 'STUDY-28': 2, 'STUDY-36': 2, 'STUDY-38': 2, 'STUDY-42': 2,
            // Score 3 (Weak but Legitimate) - 7 papers
            'STUDY-9': 3, 'STUDY-12': 3, 'STUDY-15': 3, 'STUDY-17': 3, 'STUDY-23': 3, 'STUDY-25': 3, 'STUDY-44': 3,
            // Score 4 (Decent but Limited) - 8 papers
            'STUDY-6': 4, 'STUDY-14': 4, 'STUDY-18': 4, 'STUDY-26': 4, 'STUDY-27': 4, 'STUDY-30': 4, 'STUDY-35': 4, 'STUDY-48': 4,
            // Score 5 (Good Methods with Limitations) - 6 papers
            'STUDY-3': 5, 'STUDY-5': 5, 'STUDY-13': 5, 'STUDY-16': 5, 'STUDY-21': 5, 'STUDY-45': 5,
            // Score 6 (Rigorous, Top Journals) - 7 papers
            'STUDY-2': 6, 'STUDY-10': 6, 'STUDY-22': 6, 'STUDY-31': 6, 'STUDY-33': 6, 'STUDY-37': 6, 'STUDY-41': 6,
            // Score 7 (Gold Standard) - 6 papers
            'STUDY-8': 7, 'STUDY-19': 7, 'STUDY-24': 7, 'STUDY-39': 7, 'STUDY-43': 7, 'STUDY-47': 7
        };
        const seedWeight = 100;

        // Check if user has a session ID from completing the workshop
        const userSessionId = localStorage.getItem('sessionId');
        if (userSessionId) {
            // Show the auto-detected session UI
            document.getElementById('results-link-display').style.display = 'block';
            document.getElementById('results-manual-entry').style.display = 'none';
        }

        function setupDashboardLogoAnimation() {
            const dashboardLogo = document.getElementById('dashboard-logo');
            if (!dashboardLogo) return;

            let isAnimating = false;
            let hoverTimer = null;
            const dropTypes = ['droplet', 'droplet-star', 'droplet-heart', 'droplet-sparkle', 'droplet-bubble'];

            dashboardLogo.addEventListener('mouseenter', () => {
                if (isAnimating) return;
                hoverTimer = setTimeout(() => {
                    startLogoDropAnimation();
                }, 900);
            });

            dashboardLogo.addEventListener('mouseleave', () => {
                if (hoverTimer) {
                    clearTimeout(hoverTimer);
                    hoverTimer = null;
                }
            });

            dashboardLogo.addEventListener('click', (event) => {
                if (isAnimating) return;
                event.preventDefault();
                if (hoverTimer) {
                    clearTimeout(hoverTimer);
                    hoverTimer = null;
                }
                startLogoDropAnimation();
            });

            dashboardLogo.addEventListener('touchstart', (event) => {
                if (isAnimating) return;
                event.preventDefault();
                startLogoDropAnimation();
            }, { passive: false });

            setInterval(() => {
                if (!isAnimating) {
                    dashboardLogo.classList.add('shake-intense');
                    setTimeout(() => {
                        dashboardLogo.classList.remove('shake-intense');
                    }, 2000);
                }
            }, 8000);

            function startLogoDropAnimation() {
                if (isAnimating) return;
                isAnimating = true;
                dashboardLogo.classList.add('flipping');

                const originalSrc = dashboardLogo.src;
                const invertedSrc = originalSrc.replace('unlock-lab-icon.svg', 'unlock-lab-icon-inverted.svg');

                setTimeout(() => {
                    dashboardLogo.src = invertedSrc;
                }, 600);

                setTimeout(() => {
                    dashboardLogo.src = originalSrc;
                }, 3800);

                const dropletContainer = document.createElement('div');
                dropletContainer.className = 'droplet-container';
                document.body.appendChild(dropletContainer);

                setTimeout(() => {
                    const refillRect = dashboardLogo.getBoundingClientRect();
                    const targetX = refillRect.left + refillRect.width;
                    const targetY = refillRect.top;

                    for (let i = 0; i < 12; i++) {
                        const refillDrop = document.createElement('div');
                        const randomType = dropTypes[Math.floor(Math.random() * dropTypes.length)];
                        refillDrop.className = `droplet ${randomType} droplet-refill`;

                        const startX = targetX + (Math.random() - 0.5) * window.innerWidth * 0.4;
                        const jitterTargetY = (Math.random() - 0.5) * 20;
                        const travelDistance = targetY + jitterTargetY;

                        refillDrop.style.left = `${startX}px`;
                        refillDrop.style.top = '0px';
                        refillDrop.style.width = `${2 + Math.random() * 0.5}vw`;
                        refillDrop.style.height = `${(2 + Math.random() * 0.5) * 1.2}vw`;
                        refillDrop.style.setProperty('--travel-distance', `${travelDistance}px`);
                        refillDrop.style.animationDelay = `${i * 45}ms`;

                        dropletContainer.appendChild(refillDrop);
                    }
                }, 2500);

                const logoRect = dashboardLogo.getBoundingClientRect();
                const dropCount = 8;
                const upperRightX = logoRect.left + logoRect.width;
                const upperRightY = logoRect.top;

                for (let i = 0; i < dropCount; i++) {
                    const droplet = document.createElement('div');
                    const randomType = dropTypes[Math.floor(Math.random() * dropTypes.length)];
                    droplet.className = `droplet ${randomType}`;

                    const jitterX = (Math.random() - 0.5) * 20;
                    const jitterY = (Math.random() - 0.5) * 20;
                    const size = 1 + Math.random() * 0.5;

                    droplet.style.left = `${upperRightX + jitterX}px`;
                    droplet.style.top = `${upperRightY + jitterY}px`;
                    droplet.style.width = `${size}vw`;
                    droplet.style.height = `${size * 1.2}vw`;
                    droplet.style.animationDelay = `${i * 50}ms`;

                    dropletContainer.appendChild(droplet);
                }

                setTimeout(() => {
                    const updatedRect = dashboardLogo.getBoundingClientRect();
                    const bottomLeftX = updatedRect.left;
                    const bottomLeftY = updatedRect.top + updatedRect.height;

                    for (let i = 0; i < dropCount; i++) {
                        const droplet = document.createElement('div');
                        const randomType = dropTypes[Math.floor(Math.random() * dropTypes.length)];
                        droplet.className = `droplet ${randomType}`;

                        const jitterX = (Math.random() - 0.5) * 20;
                        const jitterY = (Math.random() - 0.5) * 20;
                        const size = 1 + Math.random() * 0.5;

                        droplet.style.left = `${bottomLeftX + jitterX}px`;
                        droplet.style.top = `${bottomLeftY + jitterY}px`;
                        droplet.style.width = `${size}vw`;
                        droplet.style.height = `${size * 1.2}vw`;

                        dropletContainer.appendChild(droplet);
                    }
                }, 600);

                setTimeout(() => {
                    dashboardLogo.classList.remove('flipping');
                    dropletContainer.remove();
                    isAnimating = false;
                }, 4000);
            }
        }

        setupDashboardLogoAnimation();

        // Function to navigate to user's results page
        window.goToMyResults = function() {
            const sessionId = localStorage.getItem('sessionId');
            if (sessionId) {
                window.location.href = `../?session=${sessionId}`;
            }
        };

        // Function to load results from username input
        window.loadFromLink = function() {
            const input = document.getElementById('sessionLinkInput').value.trim();
            const errorMsg = document.getElementById('link-error');
            
            if (!input) {
                errorMsg.textContent = '‚ö†Ô∏è Please enter a username.';
                errorMsg.style.display = 'block';
                return;
            }
            
            // First, try to look up the username in the leaderboard data
            let sessionId = null;
            
            // Check if input is already a valid session ID format
            if (input.startsWith('session_') || input.includes('?session=')) {
                // Handle as session ID or URL
                try {
                    const url = new URL(input);
                    sessionId = url.searchParams.get('session');
                } catch (e) {
                    // Not a valid URL, try as session parameter format
                    if (input.includes('session=')) {
                        const match = input.match(/session=([^&\s]+)/);
                        if (match) {
                            sessionId = match[1];
                        }
                    } else if (input.startsWith('session_')) {
                        sessionId = input;
                    }
                }
            }
            
            // If not a session ID, look up username in leaderboard
            if (!sessionId && cachedLeaderboardData) {
                // Search for matching username (case-insensitive)
                const inputLower = input.toLowerCase();
                const entries = Object.entries(cachedLeaderboardData);
                
                for (const [sid, data] of entries) {
                    if (data.userName && data.userName.toLowerCase() === inputLower) {
                        sessionId = sid;
                        break;
                    }
                }
                
                if (!sessionId) {
                    // Try partial match if exact match fails
                    for (const [sid, data] of entries) {
                        if (data.userName && data.userName.toLowerCase().includes(inputLower)) {
                            sessionId = sid;
                            break;
                        }
                    }
                }
            }
            
            if (sessionId) {
                errorMsg.style.display = 'none';
                window.location.href = `../?session=${encodeURIComponent(sessionId)}`;
            } else {
                errorMsg.textContent = `‚ö†Ô∏è Username "${input}" not found. Make sure you've completed the workshop and entered your username correctly.`;
                errorMsg.style.display = 'block';
            }
        };

        // Allow Enter key to submit in the input field
        document.getElementById('sessionLinkInput')?.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                window.loadFromLink();
            }
        });

        let ratingsChart;

        // Initialize charts
        const ratingsCtx = document.getElementById('ratingsChart').getContext('2d');
        ratingsChart = new Chart(ratingsCtx, {
            type: 'bar',
            data: {
                labels: paperIds,
                datasets: [{
                    label: 'Average Rating',
                    data: [],
                    backgroundColor: function(context) {
                        const index = context.dataIndex;
                        const quality = paperQualities[paperIds[index]];
                        if (quality === 'high') return 'rgba(16, 185, 129, 0.7)';
                        if (quality === 'medium') return 'rgba(245, 158, 11, 0.7)';
                        return 'rgba(239, 68, 68, 0.7)';
                    },
                    borderColor: function(context) {
                        const index = context.dataIndex;
                        const quality = paperQualities[paperIds[index]];
                        if (quality === 'high') return 'rgba(16, 185, 129, 1)';
                        if (quality === 'medium') return 'rgba(245, 158, 11, 1)';
                        return 'rgba(239, 68, 68, 1)';
                    },
                    borderWidth: 2,
                    borderRadius: 6,
                    errorBars: {}
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                onClick: (event, activeElements, chart) => {
                    // Check if clicked on a bar
                    if (activeElements.length > 0) {
                        const index = activeElements[0].index;
                        const studyId = paperIds[index];
                        showStudyDetails(studyId);
                        return;
                    }
                    
                    // Check if clicked on x-axis label
                    const canvasPosition = Chart.helpers.getRelativePosition(event, chart);
                    const xAxis = chart.scales.x;
                    const yAxis = chart.scales.y;
                    
                    // If click is in the x-axis label area
                    if (canvasPosition.y > yAxis.bottom && canvasPosition.y < chart.height) {
                        const index = xAxis.getValueForPixel(canvasPosition.x);
                        if (index >= 0 && index < paperIds.length) {
                            showStudyDetails(paperIds[Math.round(index)]);
                        }
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        max: 7,
                        title: { 
                            display: true, 
                            text: 'Rating',
                            font: {
                                size: 14,
                                weight: 'bold'
                            },
                            color: '#374151'
                        }
                    },
                    x: {
                        ticks: {
                            callback: function(value, index) {
                                return paperIds[index];
                            },
                            font: {
                                size: 10,
                                weight: 'bold'
                            },
                            color: '#667eea'
                        }
                    }
                },
                plugins: {
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                return `Rating: ${context.parsed.y.toFixed(2)} (click for details)`;
                            }
                        }
                    },
                    legend: {
                        display: false
                    }
                }
            },
            plugins: [{
                id: 'errorBars',
                afterDatasetsDraw(chart) {
                    const ctx = chart.ctx;
                    const meta = chart.getDatasetMeta(0);
                    const errorBars = chart.data.datasets[0].errorBars;
                    
                    meta.data.forEach((bar, index) => {
                        if (!errorBars[index]) return;
                        
                        const { lower, upper } = errorBars[index];
                        const x = bar.x;

                        // Compute CI offsets relative to the mean in pixel space,
                        // then pin them to bar.y so they track the animated bar perfectly.
                        const mean = chart.data.datasets[0].data[index] || 0;
                        const yMean   = chart.scales.y.getPixelForValue(mean);
                        const yLower  = bar.y + (chart.scales.y.getPixelForValue(lower) - yMean);
                        const yUpper  = bar.y + (chart.scales.y.getPixelForValue(upper) - yMean);
                        
                        ctx.save();
                        ctx.strokeStyle = 'rgba(0, 0, 0, 0.8)';
                        ctx.lineWidth = 2;
                        
                        // Vertical line
                        ctx.beginPath();
                        ctx.moveTo(x, yLower);
                        ctx.lineTo(x, yUpper);
                        ctx.stroke();
                        
                        // Lower cap
                        ctx.beginPath();
                        ctx.moveTo(x - 5, yLower);
                        ctx.lineTo(x + 5, yLower);
                        ctx.stroke();
                        
                        // Upper cap
                        ctx.beginPath();
                        ctx.moveTo(x - 5, yUpper);
                        ctx.lineTo(x + 5, yUpper);
                        ctx.stroke();
                        
                        ctx.restore();
                    });
                }
            }]
        });

        function calculateStats(values) {
            if (!values || values.length === 0) return { mean: 0, stdDev: 0, min: 0, max: 0, agreement: 0, ci95Lower: 0, ci95Upper: 0 };
            
            const n = values.length;
            const mean = values.reduce((a, b) => a + b, 0) / n;
            const variance = values.reduce((a, b) => a + Math.pow(b - mean, 2), 0) / n;
            const stdDev = Math.sqrt(variance);
            const min = Math.min(...values);
            const max = Math.max(...values);
            
            // Calculate 95% confidence interval
            const stderr = stdDev / Math.sqrt(n);
            const tValue = 1.96; // Approximate for large n, exact for n>30
            const ci95Lower = Math.max(1, mean - tValue * stderr); // Clamp to scale minimum
            const ci95Upper = Math.min(7, mean + tValue * stderr); // Clamp to scale maximum
            
            // Agreement % (inverse of coefficient of variation, capped at 100%)
            const agreement = mean === 0 ? 0 : Math.min(100, 100 * (1 - stdDev / mean));
            
            return { 
                mean: mean.toFixed(2), 
                stdDev: stdDev.toFixed(2), 
                min: min.toFixed(1), 
                max: max.toFixed(1),
                agreement: agreement.toFixed(0),
                ci95Lower: ci95Lower.toFixed(2),
                ci95Upper: ci95Upper.toFixed(2)
            };
        }

        // Color scale function - generates background colors based on value
        function getColorScale(value, min, max, higherIsBetter = true, reducedIntensity = false) {
            const normalized = (value - min) / (max - min);
            const percent = Math.max(0, Math.min(1, normalized));
            
            if (higherIsBetter) {
                // Green for high, red for low
                if (reducedIntensity) {
                    // Lighter, more pastel colors
                    const r = Math.round(254 - (254 - 220) * percent);
                    const g = Math.round(226 + (252 - 226) * percent);
                    const b = Math.round(226 + (231 - 226) * percent);
                    return `rgb(${r}, ${g}, ${b})`;
                } else {
                    const r = Math.round(239 - (239 - 16) * percent);
                    const g = Math.round(68 + (185 - 68) * percent);
                    const b = Math.round(68 + (129 - 68) * percent);
                    return `rgb(${r}, ${g}, ${b})`;
                }
            } else {
                // Red for high, green for low (inverted)
                if (reducedIntensity) {
                    const r = Math.round(220 + (254 - 220) * percent);
                    const g = Math.round(252 - (252 - 226) * percent);
                    const b = Math.round(231 - (231 - 226) * percent);
                    return `rgb(${r}, ${g}, ${b})`;
                } else {
                    const r = Math.round(16 + (239 - 16) * percent);
                    const g = Math.round(185 - (185 - 68) * percent);
                    const b = Math.round(129 - (129 - 68) * percent);
                    return `rgb(${r}, ${g}, ${b})`;
                }
            }
        }

        function updateDashboard(ratingsData, activeData, leaderboardData) {
            const stats = {};
            let totalRatings = 0;
            let allScores = [];
            const uniqueUsers = new Set();
            const userRatingCounts = {};

            // Build a set of session IDs belonging to Anonymous users so their
            // ratings are excluded from chart and stats calculations.
            const anonymousSessionIds = new Set(
                Object.entries(leaderboardData || {})
                    .filter(([, e]) => e.userName === 'Anonymous')
                    .map(([id]) => id)
            );

            const getValidRatingEntries = (paperRatings) => {
                return Object.entries(paperRatings || {}).reduce((entries, [userId, value]) => {
                    let rating = null;

                    if (typeof value === 'number') {
                        rating = value;
                    } else if (value && typeof value === 'object') {
                        rating = value.rating;
                    }

                    if (Number.isFinite(rating) && rating >= 1 && rating <= 7 && !anonymousSessionIds.has(userId)) {
                        entries.push({ userId, rating });
                    }

                    return entries;
                }, []);
            };

            // Calculate stats for each paper
            paperIds.forEach(paperId => {
                const paperRatings = ratingsData[paperId] || {};
                const validEntries = getValidRatingEntries(paperRatings);
                const values = validEntries.map(entry => entry.rating);
                
                // Track unique user IDs and per-user rating counts
                validEntries.forEach(entry => {
                    uniqueUsers.add(entry.userId);
                    userRatingCounts[entry.userId] = (userRatingCounts[entry.userId] || 0) + 1;
                });
                
                totalRatings += values.length;
            });

            const qualifiedUserCount = Object.values(userRatingCounts).filter(c => c >= 12).length;
            
            // Determine if we have any participant data
            const hasParticipants = uniqueUsers.size > 0;
            
            // Calculate stats using all available ratings from every participant.
            paperIds.forEach(paperId => {
                const paperRatings = ratingsData[paperId] || {};
                const allEntries = getValidRatingEntries(paperRatings);
                const values = allEntries.map(entry => entry.rating);
                
                let allValues;
                if (hasParticipants) {
                    // Include seed scores in calculation (weighted as 100 participants)
                    const seedScore = seedScores[paperId] || 4;
                    allValues = [...values, ...Array(seedWeight).fill(seedScore)];
                } else {
                    // No participants - use empty array for stats
                    allValues = [];
                }
                
                stats[paperId] = {
                    ...calculateStats(allValues),
                    count: values.length,
                    totalCount: allValues.length // Total including seed
                };
            });
            
            // Store stats for modal access
            storeStatsGlobally(stats);

            // Update summary stats
            document.getElementById('uniqueParticipants').textContent = uniqueUsers.size;
            const ratingsHeading = document.getElementById('ratings-chart-heading');
            if (ratingsHeading) ratingsHeading.innerHTML = `üìä Average Quality Ratings by Study (<i>N</i>&nbsp;=&nbsp;${uniqueUsers.size})`;
            const ratingsDesc = document.getElementById('ratings-chart-desc');
            if (ratingsDesc) ratingsDesc.innerHTML = `Mean quality rating (1-7 scale) with 95% confidence intervals. Error bars show rating variability‚Äîwider bars indicate less agreement among participants. All ${uniqueUsers.size} participant${uniqueUsers.size !== 1 ? 's' : ''} with at least one valid rating are included. The leaderboard shows the subset who completed the full workshop. <strong>Click on any bar to view detailed statistics and study information.</strong>`;
            document.getElementById('totalRatings').textContent = totalRatings;
            
            const activeCount = activeData ? Object.keys(activeData).filter(key => {
                const lastActive = activeData[key].lastActive;
                return Date.now() - lastActive < 60000; // Active in last 60s
            }).length : 0;
            document.getElementById('activeParticipants').textContent = activeCount;
            
            const activeLeaderboard = leaderboardData
                ? Object.fromEntries(Object.entries(leaderboardData).filter(([, e]) => (e.score || 0) > 0 && e.userName !== 'Anonymous'))
                : {};
            const completedCount = Object.keys(activeLeaderboard).length;
            
            if (Object.keys(activeLeaderboard).length > 0) {
                // Average each person's percentage (score / papersRated) rather than
                // dividing a mean raw score by a hardcoded maximum.
                const allPercentages = Object.values(activeLeaderboard)
                    .filter(entry => (entry.papersRated || 0) > 0)
                    .map(entry => Math.round(entry.score / entry.papersRated));
                if (allPercentages.length > 0) {
                    const avgPercentage = Math.round(allPercentages.reduce((a, b) => a + b, 0) / allPercentages.length);
                    document.getElementById('avgScore').textContent = `${avgPercentage}%`;
                }
            }
            
            // Update Firebase usage statistics
            updateFirebaseUsage(activeCount, completedCount, ratingsData);
            
            // Update leaderboard table
            updateLeaderboardTable(leaderboardData);

            // Update charts and table based on participant data
            if (hasParticipants) {
                // Update charts
                const errorBars = {};
                paperIds.forEach((id, index) => {
                    errorBars[index] = {
                        lower: parseFloat(stats[id].ci95Lower),
                        upper: parseFloat(stats[id].ci95Upper)
                    };
                });
                
                ratingsChart.data.datasets[0].data = paperIds.map(id => stats[id].mean);
                ratingsChart.data.datasets[0].errorBars = errorBars;
                ratingsChart.update();

                // Update table
                const tbody = document.getElementById('statsTableBody');
                tbody.innerHTML = paperIds.map(paperId => {
                    const stat = stats[paperId];
                    const quality = paperQualities[paperId];
                    const qualityClass = quality === 'high' ? 'quality-high' : quality === 'medium' ? 'quality-medium' : 'quality-low';
                    
                    // Calculate color scales (consistent: green=high, red=low; reduced intensity)
                    const meanColor = getColorScale(stat.mean, 1, 7, true, true); // Higher rating = green
                    const stdDevColor = getColorScale(stat.stdDev, 0, 3, false, true); // Lower stdDev = green
                    const agreementPercent = parseFloat(stat.agreement);
                    const agreementColor = getColorScale(agreementPercent, 0, 100, true, true); // Higher = green
                    const responseColor = getColorScale(stat.count, 0, Math.max(...paperIds.map(id => stats[id].count)), true, true);
                    
                    return `
                        <tr data-study="${paperId}" data-quality="${quality}" data-responses="${stat.count}" 
                            data-mean="${stat.mean}" data-stddev="${stat.stdDev}" data-min="${stat.min}" 
                            data-max="${stat.max}" data-agreement="${agreementPercent}">
                            <td><strong><a href="#" onclick="showStudyDetails('${paperId}'); return false;" style="color: #667eea; text-decoration: none; cursor: pointer;">${paperId}</a></strong></td>
                            <td>
                                <span class="quality-indicator ${qualityClass}"></span>
                                ${quality.charAt(0).toUpperCase() + quality.slice(1)}
                            </td>
                            <td class="color-scale" style="background: ${responseColor}; color: #1f2937; font-weight: 600;">${stat.count}</td>
                            <td class="color-scale" style="background: ${meanColor}; color: #1f2937; font-weight: 600;">${stat.mean}</td>
                            <td class="color-scale" style="background: ${stdDevColor}; color: #1f2937; font-weight: 600;">${stat.stdDev}</td>
                            <td>${stat.min}</td>
                            <td>${stat.max}</td>
                            <td class="color-scale" style="background: ${agreementColor}; color: #1f2937; font-weight: 600;">${stat.agreement}%</td>
                        </tr>
                    `;
                }).join('');
            } else {
                // No participants - clear chart and show message
                ratingsChart.data.datasets[0].data = [];
                ratingsChart.data.datasets[0].errorBars = {};
                ratingsChart.update();

                // Show "no data" message in table
                const tbody = document.getElementById('statsTableBody');
                tbody.innerHTML = '<tr><td colspan="8" style="text-align: center; color: #999; padding: 3rem;">üìä No participant data yet. Complete the workshop to see ratings appear here.</td></tr>';
            }
        }

        // Listen to real-time updates
        let ratingsData = {};
        let activeData = {};
        let leaderboardData = {};
        let rankingsData = {};

        onValue(ref(database, 'ratings'), (snapshot) => {
            ratingsData = snapshot.val() || {};
            updateDashboard(ratingsData, activeData, leaderboardData);
        });

        onValue(ref(database, 'active'), (snapshot) => {
            activeData = snapshot.val() || {};
            updateDashboard(ratingsData, activeData, leaderboardData);
        });

        onValue(ref(database, 'leaderboard'), (snapshot) => {
            leaderboardData = snapshot.val() || {};
            updateDashboard(ratingsData, activeData, leaderboardData);
        });

        onValue(ref(database, 'rankings'), (snapshot) => {
            rankingsData = snapshot.val() || {};
            updateCriterionImportance(getFilteredRankings());
        });

        function getFilteredRankings() {
            return Object.fromEntries(
                Object.entries(rankingsData).filter(([sid]) => (cachedLeaderboardData[sid]?.score || 0) > 0)
            );
        }

        // Criterion importance visualisation
        const CRITERIA_KEYS = [
            { key: 'title',      label: 'üì∞ Title' },
            { key: 'access',     label: 'üìö Access' },
            { key: 'source',     label: 'üèõÔ∏è Source' },
            { key: 'theory',     label: 'üî¨ Theory' },
            { key: 'methods',    label: 'üìä Methods & Data' },
            { key: 'conclusion', label: 'üìù Conclusion' }
        ];

        function updateCriterionImportance(data) {
            const container = document.getElementById('criterion-importance-container');
            if (!container) return;

            const entries = Object.values(data || {});
            if (entries.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #999; padding: 2rem 0;">No data yet.</p>';
                return;
            }

            // Build participant-level criterion shares for CI calculation
            const sharesByCriterion = Object.fromEntries(CRITERIA_KEYS.map(c => [c.key, []]));
            entries.forEach(entry => {
                const participantTotal = CRITERIA_KEYS.reduce((sum, c) => sum + (Number(entry[c.key]) || 0), 0);
                if (participantTotal <= 0) return;

                CRITERIA_KEYS.forEach(c => {
                    sharesByCriterion[c.key].push((Number(entry[c.key]) || 0) / participantTotal);
                });
            });

            const n = sharesByCriterion[CRITERIA_KEYS[0].key]?.length || 0;
            if (n === 0) {
                container.innerHTML = '<p style="text-align: center; color: #999; padding: 2rem 0;">No valid token allocations yet.</p>';
                return;
            }

            // Minimum N required before showing CIs. With small N the shares are
            // compositional (sum to 100%), so an independent-normal CI for a single
            // criterion can exceed 0‚Äì100% by construction ‚Äî making the bars
            // misleading or impossible. We suppress them below this threshold.
            const CI_MIN_N = 10;
            const showCI = n >= CI_MIN_N;

            // t-distribution critical values for 95% two-sided CI (df = n-1).
            // For n >= CI_MIN_N the values are already close to z=1.96; we use a
            // lookup table with linear interpolation for accuracy.
            function getTCritical(df) {
                const table = [
                    [9, 2.262], [10, 2.228], [11, 2.201], [12, 2.179], [13, 2.160],
                    [14, 2.145], [15, 2.131], [19, 2.093], [24, 2.064], [29, 2.045],
                    [39, 2.023], [59, 2.001], [99, 1.984], [Infinity, 1.960]
                ];
                for (let i = 0; i < table.length; i++) {
                    if (df <= table[i][0]) {
                        if (i === 0) return table[0][1];
                        // Linear interpolation between table entries
                        const [df0, t0] = table[i - 1];
                        const [df1, t1] = table[i];
                        const frac = (df - df0) / (df1 - df0);
                        return t0 + frac * (t1 - t0);
                    }
                }
                return 1.960;
            }

            const tCrit = showCI ? getTCritical(n - 1) : 0;

            const criterionStats = CRITERIA_KEYS.map(c => {
                const values = sharesByCriterion[c.key];
                const mean = values.reduce((sum, value) => sum + value, 0) / n;

                let ciHalf = 0;
                if (showCI && n > 1) {
                    const variance = values.reduce((sum, value) => sum + Math.pow(value - mean, 2), 0) / (n - 1);
                    const standardError = Math.sqrt(variance / n);
                    ciHalf = tCrit * standardError;
                }

                const meanPct = mean * 100;
                const ciHalfPct = ciHalf * 100;
                const ciLowPct = Math.max(0, meanPct - ciHalfPct);
                const ciHighPct = Math.min(100, meanPct + ciHalfPct);

                return {
                    ...c,
                    meanPct,
                    ciHalfPct,
                    ciLowPct,
                    ciHighPct
                };
            });

            const formatPct = (value) => `${value.toFixed(1)}%`;

            // Update participant count in section header
            const countSpan = document.getElementById('criterion-importance-count');
            if (countSpan) countSpan.textContent = `Showing pooled responses from ${n} participant${n !== 1 ? 's' : ''} with valid token allocations.${!showCI ? ` 95% CI error bars are shown once at least ${CI_MIN_N} responses are available.` : ''}`;
            const ciHeading = document.getElementById('criterion-importance-heading');
            if (ciHeading) ciHeading.innerHTML = `‚öñÔ∏è Criterion Importance (<i>N</i>&nbsp;=&nbsp;${n})`;

            // Build bar chart
            container.innerHTML = `
                ${criterionStats.map(stat => {
                    const meanPctText = formatPct(stat.meanPct);
                    const ciWidth = Math.max(0, stat.ciHighPct - stat.ciLowPct);
                    // Label always follows the mean bar; when CIs are shown it
                    // shifts right of the upper CI tick instead.
                    const labelLeft = showCI
                        ? `calc(${stat.ciHighPct}% + 8px)`
                        : `calc(${stat.meanPct}% + 8px)`;
                    return `
                        <div style="display: flex; align-items: center; gap: 0.75rem; margin-bottom: 0.75rem;">
                            <span style="min-width: 120px; flex-shrink: 0; font-weight: 600; font-size: 0.85rem; color: #374151; white-space: nowrap;" title="${stat.label}">${stat.label}</span>
                            <div style="flex: 1; position: relative; height: 22px;">
                                <!-- Background track -->
                                <div style="position: absolute; top: 0; left: 0; right: 0; height: 100%; background: #e5e7eb; border-radius: 6px;"></div>
                                <!-- Mean bar -->
                                <div style="position: absolute; top: 0; left: 0; width: ${stat.meanPct}%; height: 100%; background: linear-gradient(90deg, #f59e0b, #d97706); border-radius: 6px;"></div>
                                ${showCI ? `
                                <!-- CI horizontal spine centred on bar height -->
                                <div style="position: absolute; top: 50%; transform: translateY(-50%); left: ${stat.ciLowPct}%; width: ${ciWidth}%; height: 2px; background: #b45309;"></div>
                                <!-- CI low tick (full bar height) -->
                                <div style="position: absolute; top: 0; bottom: 0; left: ${stat.ciLowPct}%; width: 1.5px; background: #b45309; transform: translateX(-50%);"></div>
                                <!-- CI high tick (full bar height) -->
                                <div style="position: absolute; top: 0; bottom: 0; left: ${stat.ciHighPct}%; width: 1.5px; background: #b45309; transform: translateX(-50%);"></div>
                                ` : ''}
                                <!-- Mean percentage label -->
                                <span style="position: absolute; top: 50%; transform: translateY(-50%); left: ${labelLeft}; font-weight: 700; color: #d97706; font-size: 0.82rem; white-space: nowrap;">${meanPctText}</span>
                            </div>
                        </div>`;
                }).join('')}
            `;
        }

        // Admin Panel Functions
        let adminTimer;
        let timeRemaining = 10;
        let currentUser = null;

        // Listen to auth state changes
        onAuthStateChanged(auth, (user) => {
            currentUser = user;
            if (user) {
                // User is signed in
                document.getElementById('adminEmail').textContent = `‚úÖ Signed in as ${user.email}`;
            }
        });

        window.openAdminPanel = function() {
            const overlay = document.getElementById('adminOverlay');
            overlay.classList.add('active');
            
            if (!currentUser) {
                document.getElementById('passwordSection').style.display = 'block';
                document.getElementById('adminActions').style.display = 'none';
                document.getElementById('adminEmail').value = '';
                document.getElementById('adminPassword').value = '';
                document.getElementById('adminEmail').focus();
                startTimer();
            } else {
                document.getElementById('passwordSection').style.display = 'none';
                document.getElementById('adminActions').style.display = 'block';
            }
        };

        window.closeAdminPanel = function(event) {
            // Only close if clicking overlay background or cancel button
            if (!event || event.target.id === 'adminOverlay' || event.target.classList.contains('btn-cancel')) {
                const overlay = document.getElementById('adminOverlay');
                overlay.classList.remove('active');
                clearInterval(adminTimer);
                timeRemaining = 10;
            }
        };

        function startTimer() {
            timeRemaining = 10;
            updateTimerDisplay();
            
            adminTimer = setInterval(() => {
                timeRemaining--;
                updateTimerDisplay();
                
                if (timeRemaining <= 0) {
                    clearInterval(adminTimer);
                    closeAdminPanel({ target: { id: 'adminOverlay' } });
                }
            }, 1000);
        }

        function updateTimerDisplay() {
            const timerElement = document.getElementById('adminTimer');
            timerElement.textContent = `Time remaining: ${timeRemaining}s`;
            
            if (timeRemaining <= 3) {
                timerElement.classList.add('warning');
            } else {
                timerElement.classList.remove('warning');
            }
        }

        window.handlePasswordKeyPress = function(event) {
            if (event.key === 'Enter') {
                verifyPassword();
            }
        };

        window.verifyPassword = function() {
            const email = document.getElementById('adminEmail').value.trim();
            const password = document.getElementById('adminPassword').value;
            
            if (!email || !password) {
                alert('‚ùå Please enter both email and password');
                return;
            }
            
            const loginBtn = document.getElementById('loginBtn');
            loginBtn.disabled = true;
            loginBtn.textContent = 'Signing in...';
            
            signInWithEmailAndPassword(auth, email, password)
                .then((userCredential) => {
                    clearInterval(adminTimer);
                    currentUser = userCredential.user;
                    document.getElementById('passwordSection').style.display = 'none';
                    document.getElementById('adminActions').style.display = 'block';
                    document.getElementById('adminTitle').textContent = '‚úÖ Admin Panel';
                    loginBtn.disabled = false;
                    loginBtn.textContent = 'Sign In';
                })
                .catch((error) => {
                    let message = 'Authentication failed';
                    if (error.code === 'auth/invalid-credential' || error.code === 'auth/wrong-password' || error.code === 'auth/user-not-found') {
                        message = 'Invalid email or password';
                    } else if (error.code === 'auth/too-many-requests') {
                        message = 'Too many failed attempts. Try again later';
                    }
                    alert('‚ùå ' + message);
                    document.getElementById('adminPassword').value = '';
                    loginBtn.disabled = false;
                    loginBtn.textContent = 'Sign In';
                });
        };

        window.adminSignOut = function() {
            signOut(auth).then(() => {
                currentUser = null;
                closeAdminPanel({ target: { id: 'adminOverlay' } });
            }).catch((error) => {
                alert('‚ùå Error signing out: ' + error.message);
            });
        };

        window.endAllSessions = function() {
            const activeCount = Object.keys(activeData).length;
            
            if (activeCount === 0) {
                alert('‚ÑπÔ∏è No active sessions to end');
                return;
            }
            
            if (confirm(`‚ö†Ô∏è This will end ${activeCount} active session(s).\n\nAre you sure you want to continue?`)) {
                const btn = document.getElementById('endSessionsBtn');
                btn.disabled = true;
                btn.textContent = 'Ending sessions...';
                
                set(ref(database, 'active'), null)
                    .then(() => {
                        alert(`‚úÖ Successfully ended ${activeCount} session(s)`);
                        btn.disabled = false;
                        btn.textContent = '‚èπÔ∏è End all active sessions';
                        closeAdminPanel({ target: { id: 'adminOverlay' } });
                    })
                    .catch((error) => {
                        alert('‚ùå Error ending sessions: ' + error.message);
                        btn.disabled = false;
                        btn.textContent = '‚èπÔ∏è End all active sessions';
                    });
            }
        };

        window.deleteAllRatingsData = async function() {
            const ratingsRef = ref(database, 'ratings');
            const leaderboardRef = ref(database, 'leaderboard');
            const rankingsRef = ref(database, 'rankings');
            
            try {
                const [ratingsSnapshot, leaderboardSnapshot, rankingsSnapshot] = await Promise.all([
                    get(ratingsRef),
                    get(leaderboardRef),
                    get(rankingsRef)
                ]);
                
                const hasRatings = ratingsSnapshot.exists();
                const hasLeaderboard = leaderboardSnapshot.exists();
                const hasRankings = rankingsSnapshot.exists();
                
                if (!hasRatings && !hasLeaderboard && !hasRankings) {
                    alert('‚ÑπÔ∏è No data to delete.');
                    return;
                }
                
                let totalRatings = 0;
                let totalParticipants = 0;
                let totalRankings = 0;
                
                if (hasRatings) {
                    const ratings = ratingsSnapshot.val();
                    Object.values(ratings).forEach(paper => {
                        totalRatings += Object.keys(paper).length;
                    });
                }
                
                if (hasLeaderboard) {
                    totalParticipants = Object.keys(leaderboardSnapshot.val()).length;
                }
                
                if (hasRankings) {
                    totalRankings = Object.keys(rankingsSnapshot.val()).length;
                }
                
                const confirmMsg = `‚ö†Ô∏è WARNING: You are about to permanently delete:\n‚Ä¢ ${totalRatings} rating(s)\n‚Ä¢ ${totalParticipants} participant(s) from leaderboard\n‚Ä¢ ${totalRankings} criterion ranking(s)\n\nThis action CANNOT be undone!\n\nType "DELETE" to confirm:`;
                const userInput = prompt(confirmMsg);
                
                if (userInput !== 'DELETE') {
                    alert('‚ùå Deletion cancelled.');
                    return;
                }
                
                const btn = document.getElementById('deleteDataBtn');
                btn.disabled = true;
                btn.textContent = 'Deleting data...';
                
                // Delete ratings, leaderboard, and rankings
                await Promise.all([
                    hasRatings ? remove(ratingsRef) : Promise.resolve(),
                    hasLeaderboard ? remove(leaderboardRef) : Promise.resolve(),
                    hasRankings ? remove(rankingsRef) : Promise.resolve()
                ]);
                
                alert('‚úÖ All data has been permanently deleted.');
                
                // Reload the page to refresh all data
                window.location.reload();
                
            } catch (error) {
                alert('‚ùå Error deleting data: ' + error.message);
                const btn = document.getElementById('deleteDataBtn');
                if (btn) {
                    btn.disabled = false;
                    btn.textContent = 'üóëÔ∏è Delete all ratings data';
                }
            }
        };

        // Table sorting
        let currentSort = { column: -1, ascending: true };

        window.sortTable = function(columnIndex, dataType) {
            const table = document.getElementById('statsTable');
            const tbody = table.querySelector('tbody');
            const rows = Array.from(tbody.querySelectorAll('tr'));
            
            // Determine sort direction
            const ascending = currentSort.column === columnIndex ? !currentSort.ascending : true;
            currentSort = { column: columnIndex, ascending };
            
            // Update header indicators
            table.querySelectorAll('th').forEach((th, index) => {
                th.classList.remove('sort-asc', 'sort-desc');
                if (index === columnIndex) {
                    th.classList.add(ascending ? 'sort-asc' : 'sort-desc');
                }
            });
            
            // Get data attributes mapping
            const dataAttrs = ['study', 'quality', 'responses', 'mean', 'stddev', 'min', 'max', 'agreement'];
            const attr = dataAttrs[columnIndex];
            
            // Quality ordering for logical sorting
            const qualityOrder = { 'low': 1, 'medium': 2, 'high': 3 };
            
            // Sort rows
            rows.sort((a, b) => {
                let aVal = a.dataset[attr];
                let bVal = b.dataset[attr];
                
                // Special handling for quality column
                if (columnIndex === 1) {
                    aVal = qualityOrder[aVal] || 0;
                    bVal = qualityOrder[bVal] || 0;
                } else if (dataType === 'number') {
                    aVal = parseFloat(aVal);
                    bVal = parseFloat(bVal);
                } else {
                    aVal = aVal.toLowerCase();
                    bVal = bVal.toLowerCase();
                }
                
                if (aVal < bVal) return ascending ? -1 : 1;
                if (aVal > bVal) return ascending ? 1 : -1;
                return 0;
            });
            
            // Rebuild table
            rows.forEach(row => tbody.appendChild(row));
        };
        
        // Update Firebase usage statistics
        function updateFirebaseUsage(activeCount, completedCount, ratingsData) {
            // Concurrent connections (active participants)
            const connectionPercent = Math.min(100, (activeCount / 100) * 100);
            document.getElementById('connectionUsage').textContent = `${activeCount}/100`;
            document.getElementById('connectionBar').style.width = `${connectionPercent}%`;
            
            // Update color based on usage
            const connectionBar = document.getElementById('connectionBar');
            const connectionUsageText = document.getElementById('connectionUsage');
            if (connectionPercent >= 90) {
                connectionBar.style.background = '#ef4444'; // Red - critical
                connectionUsageText.style.color = '#ef4444';
            } else if (connectionPercent >= 70) {
                connectionBar.style.background = '#f59e0b'; // Orange - warning
                connectionUsageText.style.color = '#f59e0b';
            } else {
                connectionBar.style.background = '#10b981'; // Green - safe
                connectionUsageText.style.color = '#10b981';
            }
            
            // Estimate data storage (rough calculation)
            // Each rating entry ~200 bytes, each active entry ~100 bytes, each leaderboard entry ~150 bytes
            const ratingsCount = ratingsData ? Object.keys(ratingsData).reduce((count, sessionId) => {
                return count + Object.keys(ratingsData[sessionId] || {}).length;
            }, 0) : 0;
            
            const estimatedBytes = (ratingsCount * 200) + (activeCount * 100) + (completedCount * 150);
            const estimatedMB = (estimatedBytes / (1024 * 1024)).toFixed(2);
            const storagePercent = Math.min(100, (estimatedMB / 1024) * 100); // 1 GB = 1024 MB
            
            document.getElementById('storageUsage').textContent = `~${estimatedMB} MB`;
            document.getElementById('storageBar').style.width = `${storagePercent}%`;
            
            const storageBar = document.getElementById('storageBar');
            if (storagePercent >= 90) {
                storageBar.style.background = '#ef4444';
            } else if (storagePercent >= 70) {
                storageBar.style.background = '#f59e0b';
            } else {
                storageBar.style.background = '#10b981';
            }
            
            // Total sessions
            document.getElementById('sessionCount').textContent = completedCount;
        }
        
        // Update leaderboard table
        let currentLeaderboardTab = 'allTime';
        let cachedLeaderboardData = {};
        
        function updateLeaderboardTable(leaderboardData) {
            cachedLeaderboardData = leaderboardData || {};
            renderLeaderboard();
            updateCriterionImportance(getFilteredRankings());
        }
        
        function switchLeaderboardTab(tab) {
            currentLeaderboardTab = tab;
            
            // Update tab styles
            const tab24h = document.getElementById('tab24h');
            const tabAllTime = document.getElementById('tabAllTime');
            
            if (tab === '24h') {
                tab24h.style.color = '#059669';
                tab24h.style.fontWeight = 'bold';
                tab24h.style.borderBottom = '3px solid #059669';
                tabAllTime.style.color = '#6b7280';
                tabAllTime.style.fontWeight = 'normal';
                tabAllTime.style.borderBottom = '3px solid transparent';
            } else {
                tabAllTime.style.color = '#059669';
                tabAllTime.style.fontWeight = 'bold';
                tabAllTime.style.borderBottom = '3px solid #059669';
                tab24h.style.color = '#6b7280';
                tab24h.style.fontWeight = 'normal';
                tab24h.style.borderBottom = '3px solid transparent';
            }
            
            renderLeaderboard();
        }
        
        // Expose to global scope for onclick handlers
        window.switchLeaderboardTab = switchLeaderboardTab;
        
        function renderLeaderboard() {
            const grid = document.getElementById('leaderboardGrid');
            
            if (!cachedLeaderboardData || Object.keys(cachedLeaderboardData).length === 0) {
                grid.innerHTML = '<div style="text-align: center; color: #999; grid-column: 1 / -1;">No completed sessions yet</div>';
                return;
            }
            
            // Convert to array
            let entries = Object.entries(cachedLeaderboardData).map(([sessionId, data]) => ({
                sessionId,
                userName: data.userName || 'Anonymous',
                score: data.score || 0,
                papersRated: data.papersRated || 0,
                timestamp: data.timestamp || 0
            }));
            
            // Exclude 0-score entries and the Anonymous placeholder user
            entries = entries.filter(entry => entry.score > 0 && entry.userName !== 'Anonymous');

            // Filter by 24 hours if that tab is active
            if (currentLeaderboardTab === '24h') {
                const twentyFourHoursAgo = Date.now() - (24 * 60 * 60 * 1000);
                entries = entries.filter(entry => entry.timestamp >= twentyFourHoursAgo);
            }
            
            // Sort by score (descending) and limit to top 200
            entries = entries.sort((a, b) => b.score - a.score).slice(0, 200);
            
            if (entries.length === 0) {
                grid.innerHTML = '<div style="text-align: center; color: #999; grid-column: 1 / -1;">No completed sessions in the past 24 hours</div>';
                return;
            }
            
            // Generate grid cards
            grid.innerHTML = entries.map((entry, index) => {
                const rank = index + 1;
                const percentageScore = entry.papersRated > 0 ? Math.round(entry.score / entry.papersRated) : 0;
                const medal = rank === 1 ? ' ü•á' : rank === 2 ? ' ü•à' : rank === 3 ? ' ü•â' : '';
                const displayRank = `#${rank}`;
                
                // Define rank-specific styling variables for template rendering
                let bgColor = '#f9fafb';
                let borderColor = '#e5e7eb';
                if (rank === 1) {
                    bgColor = '#fef3c7';
                    borderColor = '#fbbf24';
                } else if (rank === 2) {
                    bgColor = '#e0e7ff';
                    borderColor = '#818cf8';
                } else if (rank === 3) {
                    bgColor = '#fce7f3';
                    borderColor = '#f472b6';
                }
                
                const fontWeight = rank <= 3 ? 'bold' : '500';
                const scoreColor = percentageScore >= 80 ? '#10b981' : percentageScore >= 60 ? '#3b82f6' : percentageScore >= 40 ? '#f59e0b' : '#ef4444';
                
                return `
                    <div role="link" tabindex="0" title="View ${entry.userName}'s results" onclick="window.location.href='../?session=${encodeURIComponent(entry.sessionId)}'" onkeydown="if(event.key==='Enter'||event.key===' ')window.location.href='../?session=${encodeURIComponent(entry.sessionId)}'" style="
                        background: ${bgColor};
                        border: 1px solid ${borderColor};
                        border-radius: 6px;
                        padding: 10px;
                        display: flex;
                        align-items: center;
                        justify-content: space-between;
                        gap: 8px;
                        transition: transform 0.2s, box-shadow 0.2s;
                        cursor: pointer;
                    " onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 4px 12px rgba(0,0,0,0.15)';" onmouseout="this.style.transform=''; this.style.boxShadow='';">
                        <div style="font-size: 0.8rem; font-weight: bold; color: #6b7280; flex-shrink: 0;">${displayRank}</div>
                        <div style="font-size: 0.85rem; color: #1f2937; font-weight: ${fontWeight}; flex-grow: 1; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">${entry.userName}${medal}</div>
                        <div style="font-size: 0.9rem; font-weight: bold; color: ${scoreColor}; flex-shrink: 0;">${percentageScore}%</div>
                    </div>
                `;
            }).join('');
        }
        
        // Study details modal functions
        let currentStats = {};
        
        window.showStudyDetails = function(studyId) {
            const modal = document.getElementById('studyModal');
            const quality = paperQualities[studyId];
            const stats = currentStats[studyId];
            const paperInfo = papersData[studyId];
            
            if (!stats) {
                alert('No data available for this study yet.');
                return;
            }
            
            document.getElementById('studyTitle').textContent = studyId;
            document.getElementById('studyQuality').innerHTML = `
                <span style="display: inline-block; width: 12px; height: 12px; border-radius: 50%; background: ${quality === 'high' ? '#10b981' : quality === 'medium' ? '#f59e0b' : '#ef4444'}; margin-right: 8px;"></span>
                <strong>Quality Level:</strong> ${quality.charAt(0).toUpperCase() + quality.slice(1)}
            `;
            
            let studyDetailsHtml = '';
            if (paperInfo) {
                studyDetailsHtml = `
                    <div style="background: #f9fafb; padding: 1.5rem; border-radius: 8px; margin-top: 1rem;">
                        <h3 style="margin-top: 0; color: #20B2AA;">Rating Statistics</h3>
                        <table style="width: 100%; border-collapse: collapse;">
                            <tr style="border-bottom: 1px solid #e5e7eb;">
                                <td style="padding: 0.75rem; font-weight: 600;">Participants:</td>
                                <td style="padding: 0.75rem;">${stats.count}</td>
                            </tr>
                            <tr style="border-bottom: 1px solid #e5e7eb;">
                                <td style="padding: 0.75rem; font-weight: 600;">Mean Rating:</td>
                                <td style="padding: 0.75rem;">${stats.mean} / 7</td>
                            </tr>
                            <tr style="border-bottom: 1px solid #e5e7eb;">
                                <td style="padding: 0.75rem; font-weight: 600;">95% CI:</td>
                                <td style="padding: 0.75rem;">[${stats.ci95Lower}, ${stats.ci95Upper}]</td>
                            </tr>
                            <tr style="border-bottom: 1px solid #e5e7eb;">
                                <td style="padding: 0.75rem; font-weight: 600;">Std Deviation:</td>
                                <td style="padding: 0.75rem;">${stats.stdDev}</td>
                            </tr>
                            <tr style="border-bottom: 1px solid #e5e7eb;">
                                <td style="padding: 0.75rem; font-weight: 600;">Range:</td>
                                <td style="padding: 0.75rem;">${stats.min} - ${stats.max}</td>
                            </tr>
                            <tr>
                                <td style="padding: 0.75rem; font-weight: 600;">Agreement:</td>
                                <td style="padding: 0.75rem;">${stats.agreement}%</td>
                            </tr>
                        </table>
                        <p style="font-size: 0.85rem; color: #6b7280; margin-top: 1rem; margin-bottom: 0;">
                            <strong>What this means:</strong> ${parseInt(stats.agreement) > 70 ? 'High agreement among participants - ratings are consistent.' : parseInt(stats.agreement) > 40 ? 'Moderate agreement - some variation in ratings.' : 'Low agreement - participants have quite different opinions about this study.'}
                        </p>
                    </div>
                    
                    <hr style="margin: 2rem 0; border: none; border-top: 2px solid #e5e7eb;">
                    
                    <div style="margin-top: 1.5rem;">
                        <h3 style="margin-top: 0; color: #20B2AA;">Study Details</h3>
                        <div style="background: #ffffff; padding: 0.4rem 1rem; border-left: 4px solid #20B2AA; margin-bottom: 1rem;">
                            <h4 style="margin: 0; color: #374151; font-size: 1rem;">${paperInfo.title}</h4>
                        </div>
                        
                        <div style="margin-bottom: 1.25rem;">
                            <h4 style="color: #20B2AA; font-size: 0.9rem; margin-bottom: 0.5rem;">üìö Access</h4>
                            <p style="margin: 0; font-size: 0.85rem; line-height: 1.6;">${paperInfo.access}</p>
                        </div>
                        
                        <div style="margin-bottom: 1.25rem;">
                            <h4 style="color: #20B2AA; font-size: 0.9rem; margin-bottom: 0.5rem;">üîç Overview</h4>
                            <p style="margin: 0; font-size: 0.85rem; line-height: 1.6;">${paperInfo.overview}</p>
                        </div>
                        
                        <div style="margin-bottom: 1.25rem;">
                            <h4 style="color: #20B2AA; font-size: 0.9rem; margin-bottom: 0.5rem;">üß™ Methods</h4>
                            <p style="margin: 0; font-size: 0.85rem; line-height: 1.6;">${paperInfo.methods}</p>
                        </div>
                        
                        <div style="margin-bottom: 1.25rem;">
                            <h4 style="color: #20B2AA; font-size: 0.9rem; margin-bottom: 0.5rem;">üí° Conclusion</h4>
                            <p style="margin: 0; font-size: 0.85rem; line-height: 1.6;">${paperInfo.conclusion}</p>
                        </div>
                        
                        <div style="margin-bottom: 0;">
                            <h4 style="color: #20B2AA; font-size: 0.9rem; margin-bottom: 0.5rem;">üì∞ Source</h4>
                            <p style="margin: 0; font-size: 0.85rem; line-height: 1.6;">${paperInfo.source}</p>
                        </div>
                    </div>
                `;
            } else {
                studyDetailsHtml = `
                    <div style="background: #f9fafb; padding: 1.5rem; border-radius: 8px; margin-top: 1rem;">
                        <h3 style="margin-top: 0; color: #20B2AA;">Rating Statistics</h3>
                        <table style="width: 100%; border-collapse: collapse;">
                            <tr style="border-bottom: 1px solid #e5e7eb;">
                                <td style="padding: 0.75rem; font-weight: 600;">Participants:</td>
                                <td style="padding: 0.75rem;">${stats.count}</td>
                            </tr>
                            <tr style="border-bottom: 1px solid #e5e7eb;">
                                <td style="padding: 0.75rem; font-weight: 600;">Mean Rating:</td>
                                <td style="padding: 0.75rem;">${stats.mean} / 7</td>
                            </tr>
                            <tr style="border-bottom: 1px solid #e5e7eb;">
                                <td style="padding: 0.75rem; font-weight: 600;">95% CI:</td>
                                <td style="padding: 0.75rem;">[${stats.ci95Lower}, ${stats.ci95Upper}]</td>
                            </tr>
                            <tr style="border-bottom: 1px solid #e5e7eb;">
                                <td style="padding: 0.75rem; font-weight: 600;">Std Deviation:</td>
                                <td style="padding: 0.75rem;">${stats.stdDev}</td>
                            </tr>
                            <tr style="border-bottom: 1px solid #e5e7eb;">
                                <td style="padding: 0.75rem; font-weight: 600;">Range:</td>
                                <td style="padding: 0.75rem;">${stats.min} - ${stats.max}</td>
                            </tr>
                            <tr>
                                <td style="padding: 0.75rem; font-weight: 600;">Agreement:</td>
                                <td style="padding: 0.75rem;">${stats.agreement}%</td>
                            </tr>
                        </table>
                        <p style="font-size: 0.85rem; color: #6b7280; margin-top: 1rem; margin-bottom: 0;">
                            <strong>What this means:</strong> ${parseInt(stats.agreement) > 70 ? 'High agreement among participants - ratings are consistent.' : parseInt(stats.agreement) > 40 ? 'Moderate agreement - some variation in ratings.' : 'Low agreement - participants have quite different opinions about this study.'}
                        </p>
                    </div>
                `;
            }
            
            document.getElementById('studyStats').innerHTML = studyDetailsHtml;
            
            modal.classList.add('active');
        };
        
        window.closeStudyModal = function() {
            document.getElementById('studyModal').classList.remove('active');
        };
        
        // Close modal with ESC key
        document.addEventListener('keydown', function(event) {
            if (event.key === 'Escape' || event.key === 'Esc') {
                const modal = document.getElementById('studyModal');
                if (modal.classList.contains('active')) {
                    closeStudyModal();
                }
            }
        });
        
        // Store stats globally for modal access
        function storeStatsGlobally(stats) {
            currentStats = stats;
        }
    </script>
</body>
</html>
